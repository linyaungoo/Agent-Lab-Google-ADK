#! /usr/bin/env node
/**
  * @license
  * Copyright 2025 Google LLC
  * SPDX-License-Identifier: Apache-2.0
  */

"use strict";var st=Object.create;var Pe=Object.defineProperty;var rt=Object.getOwnPropertyDescriptor;var nt=Object.getOwnPropertyNames;var ot=Object.getPrototypeOf,at=Object.prototype.hasOwnProperty;var Oe=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),Re=e=>{throw TypeError(e)};var it=(e,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of nt(t))!at.call(e,n)&&n!==s&&Pe(e,n,{get:()=>t[n],enumerable:!(r=rt(t,n))||r.enumerable});return e};var f=(e,t,s)=>(s=e!=null?st(ot(e)):{},it(t||!e||!e.__esModule?Pe(s,"default",{value:e,enumerable:!0}):s,e));var D=(e,t,s)=>{if(t!=null){typeof t!="object"&&typeof t!="function"&&Re("Object expected");var r,n;s&&(r=t[Oe("asyncDispose")]),r===void 0&&(r=t[Oe("dispose")],s&&(n=r)),typeof r!="function"&&Re("Object not disposable"),n&&(r=function(){try{n.call(this)}catch(o){return Promise.reject(o)}}),e.push([s,r,t])}else s&&e.push([s]);return t},L=(e,t,s)=>{var r=typeof SuppressedError=="function"?SuppressedError:function(a,i,c,l){return l=Error(c),l.name="SuppressedError",l.error=a,l.suppressed=i,l},n=a=>t=s?new r(a,t,"An error was suppressed during disposal"):(s=!0,a),o=a=>{for(;a=e.pop();)try{var i=a[1]&&a[1].call(a[2]);if(a[0])return Promise.resolve(i).then(o,c=>(n(c),o()))}catch(c){n(c)}if(s)throw t};return o()};var A=require("@google/adk"),O=require("commander"),Ze=f(require("dotenv")),et=f(require("os")),oe=f(require("path"));var y=require("@google/adk"),Be=require("@opentelemetry/api"),fe=require("@opentelemetry/sdk-trace-base"),Ue=f(require("cors")),V=f(require("express")),Me=f(require("path"));var Z=require("@google/adk"),xe=f(require("esbuild")),C=f(require("fs/promises")),P=f(require("path"));var S=f(require("fs/promises")),Te=f(require("os")),X=f(require("path"));async function H(e){try{return await S.access(e),!0}catch{return!1}}async function de(e){try{await S.mkdir(e)}catch(t){console.error(`Failed to create folder ${e}`,t)}}async function Ne(e){try{await S.rm(e,{recursive:!0})}catch(t){console.error(`Failed to remove folder ${e}`,t)}}async function Ee(e){try{return await S.readdir(e)}catch(t){return console.error(`Failed to list files in folder ${e}`,t),[]}}async function z(e){try{return(await S.stat(e)).isFile()}catch{return!1}}async function K(e){try{return JSON.parse(await S.readFile(e,{encoding:"utf-8"}))}catch(t){throw console.error(`Failed to read or parse file ${e}:`,t),t}}async function R(e,t){try{await S.writeFile(e,typeof t=="string"?t:JSON.stringify(t,null,2),{encoding:"utf-8"})}catch(s){throw console.error(`Failed to write file ${e}:`,s),s}}function Q(e){let t=[Te.tmpdir()];return e&&t.push(e),t.push(Date.now().toString()),X.join(...t)}async function je(e,t,s){let r=e;for(let n=0;n<s;n++){let o=X.join(r,t);if(await H(o))return o;r=X.join(r,"../")}throw new Error(`No ${t} found in ${e} or its parent folders up to ${s} levels.`)}var ct=[".ts",".mts"],lt=[".js",".cjs",".mjs",".ts",".mts"],$=class extends Error{};var ke={bundle:"ts"},G=class{constructor(t,s=ke){this.filePath=t;this.options=s;this.disposed=!1}async load(){if(this.agent)return this.agent;try{await C.stat(this.filePath)}catch(n){if(n.code==="ENOENT")throw new $(`Agent file ${this.filePath} does not exists`)}let t=this.filePath,s=P.extname(t);if(this.options.bundle==="any"||ct.includes(s)){let n=P.parse(t),o=P.join(Q("adk_agent_loader"),n.name+".cjs");await xe.default.build({entryPoints:[t],outfile:o,target:"node10.4",platform:"node",format:"cjs",packages:"bundle",bundle:!0,minify:!0,allowOverwrite:!0}),this.cleanupFilePath=o,t=o}let r=await Promise.resolve().then(()=>f(require(t)));if(r){if((0,Z.isBaseAgent)(r.rootAgent))return this.agent=r.rootAgent;if((0,Z.isBaseAgent)(r.default))return this.agent=r.default;let n=Object.values(r).filter(o=>(0,Z.isBaseAgent)(o));if(n.length>1&&console.warn(`Multiple agents found in ${t}. Using the ${n[0].name} as a root agent.`),n.length>0)return this.agent=n[0]}throw this.dispose(),new $(`Failed to load agent ${t}: No @google/adk BaseAgent class instance found. Please check that file is not empty and it has export of @google/adk BaseAgent class (e.g. LlmAgent) instance.`)}getFilePath(){if(!this.agent)throw new Error("Agent is not loaded yet");if(this.disposed)throw new Error("Agent is disposed and can not be used");return this.cleanupFilePath||this.filePath}async[Symbol.asyncDispose](){return this.dispose()}async dispose(){if(!this.disposed&&this.cleanupFilePath)return this.disposed=!0,C.unlink(this.cleanupFilePath)}},B=class{constructor(t=process.cwd(),s=ke){this.agentsDirPath=t;this.options=s;this.agentsAlreadyPreloaded=!1;this.preloadedAgents={};let r=async({exit:n,cleanup:o})=>{o&&await this.disposeAll(),n&&process.exit()};process.on("exit",()=>r({cleanup:!0})),process.on("SIGINT",()=>r({exit:!0})),process.on("SIGUSR1",()=>r({exit:!0})),process.on("SIGUSR2",()=>r({exit:!0})),process.on("uncaughtException",()=>r({exit:!0}))}async listAgents(){return await this.preloadAgents(),Object.keys(this.preloadedAgents).sort()}async getAgentFile(t){return await this.preloadAgents(),this.preloadedAgents[t]}async disposeAll(){await Promise.all(Object.values(this.preloadedAgents).map(t=>t.dispose()))}async preloadAgents(){if(this.agentsAlreadyPreloaded)return;let t=await z(this.agentsDirPath)?[await De(this.agentsDirPath)]:await Ce(this.agentsDirPath);await Promise.all(t.map(async s=>{if(s.isFile&&Fe(s.ext))return this.loadAgentFromFile(s);if(s.isDirectory)return this.loadAgentFromDirectory(s)})),this.agentsAlreadyPreloaded=!0}async loadAgentFromFile(t){try{let s=new G(t.path,this.options);await s.load(),this.preloadedAgents[t.name]=s}catch(s){if(s instanceof $)return;throw s}}async loadAgentFromDirectory(t){let r=(await Ce(t.path)).find(n=>n.isFile&&n.name==="agent"&&Fe(n.ext));if(r)try{let n=new G(r.path,this.options);await n.load(),this.preloadedAgents[t.name]=n}catch(n){if(n instanceof $)return;throw n}}};function Fe(e){return!!e&&lt.includes(e)}async function Ce(e){let t=await C.readdir(e);return await Promise.all(t.map(s=>De(P.join(e,s))))}async function De(e){let t=await C.stat(e),s=t.isFile(),r=P.basename(e),n=P.extname(e);return{path:e,name:s?r.slice(0,r.length-n.length):r,ext:s?P.extname(e):void 0,isFile:s,isDirectory:t.isDirectory()}}var E=require("@google/adk");function pe(e){if(!e||!Array.isArray(e)||e.length!==2)return 0;let[t,s]=e;return t*1e9+s}var ee=class{constructor(t){this.traceDict=t}export(t,s){for(let r of t)if(r.name==="call_llm"||r.name==="send_data"||r.name.startsWith("execute_tool")){let n={...r.attributes};n.trace_id=r.spanContext().traceId,n.span_id=r.spanContext().spanId;let o=n["gcp.vertex.agent.event_id"];o&&(this.traceDict[o]=n)}s({code:0})}forceFlush(){return Promise.resolve()}shutdown(){return Promise.resolve()}},te=class{constructor(t){this.spans=[];this.traceDict=t}export(t,s){for(let r of t){let n=r.spanContext().traceId;if(r.name==="call_llm"){let a={...r.attributes}["gcp.vertex.agent.session_id"];a&&(this.traceDict[a]?this.traceDict[a].push(n):this.traceDict[a]=[n])}}this.spans.push(...t),s({code:0})}forceFlush(){return Promise.resolve()}shutdown(){return Promise.resolve()}getFinishedSpans(t){let s=this.traceDict[t];return!s||s.length===0?[]:this.spans.filter(r=>s.includes(r.spanContext().traceId))}clear(){this.spans=[]}};function ut(){return["OTEL_EXPORTER_OTLP_ENDPOINT","OTEL_EXPORTER_OTLP_TRACES_ENDPOINT","OTEL_EXPORTER_OTLP_METRICS_ENDPOINT","OTEL_EXPORTER_OTLP_LOGS_ENDPOINT"].some(t=>process.env[t])}async function Le(e=!1,t=[]){e?await dt(t):ut()?await pt(t):(0,E.maybeSetOtelProviders)([{spanProcessors:t}])}async function dt(e=[]){let t=[];e.length>0&&t.push({spanProcessors:e});let s=await(0,E.getGcpExporters)({enableTracing:!0,enableLogging:!1,enableMetrics:!0});t.push(s);let r=(0,E.getGcpResource)();(0,E.maybeSetOtelProviders)(t,r)}async function pt(e=[]){let t=[];e.length>0&&t.push({spanProcessors:e}),(0,E.maybeSetOtelProviders)(t)}var u=require("@google/adk"),h=require("ts-graphviz");var $e="#0F5223",ge="#69CB87",U="#cccccc",me="#ffffff";async function M(e,t,s,r){async function n(i,c){if((0,u.isLoopAgent)(c)){r&&a(r.name,c.subAgents[0].name);let l=c.subAgents.length,d=0;for(let w of c.subAgents){await M(i,w,s,c);let p=d===l-1?c.subAgents[0]:c.subAgents[d+1];a(c.subAgents[d].name,p.name),d++}}else if((0,u.isSequentialAgent)(c)){r&&a(r.name,c.subAgents[0].name);let l=c.subAgents.length,d=0;for(let w of c.subAgents)await M(i,w,s,c),d!==l-1&&a(c.subAgents[d].name,c.subAgents[d+1].name),d++}else if((0,u.isParallelAgent)(c))for(let l of c.subAgents)await M(i,l,s,c),r&&a(r.name,l.name);else for(let l of c.subAgents)await M(i,l,s,c),a(c.name,l.name);return i}async function o(i){let c=Ge(i),l=mt(i),d=gt(i),w=se(i);if(s){for(let p of s)if(p.includes(c)){if(w){let m=new h.Subgraph(`cluster_${c}`,{label:`cluster_${c}`,style:"rounded",bgcolor:me,fontcolor:U});e.addSubgraph(m),await n(m,t)}else e.addNode(new h.Node(c,{label:d,style:"filled,rounded",fillcolor:$e,color:$e,shape:l,fontcolor:U}));return}}if(w){let p=new h.Subgraph(`cluster_${c}`,{label:`cluster_${c}`,style:"rounded",bgcolor:me,fontcolor:U});e.addSubgraph(p),await n(p,t);return}e.addNode(new h.Node(c,{label:d,style:"rounded",fillcolor:me,color:U,shape:l,fontcolor:U}))}function a(i,c){if(s)for(let[l,d]of s){if(i===l&&c===d){e.addEdge(new h.Edge([e.node(i),e.node(c)],{color:ge}));return}if(i===d&&c===l){e.addEdge(new h.Edge([e.node(i),e.node(c)],{color:ge,dir:"back"}));return}}if(se(t)){e.addEdge(new h.Edge([new h.Node(i),new h.Node(c)],{color:ge}));return}e.addEdge(new h.Edge([new h.Node(i),new h.Node(c)],{arrowhead:"none",color:U}))}await o(t);for(let i of t.subAgents)await M(e,i,s,t),!se(i)&&!se(t)&&a(t.name,i.name);if((0,u.isLlmAgent)(t))for(let i of await t.canonicalTools())await o(i),a(t.name,Ge(i))}function Ge(e){if((0,u.isBaseAgent)(e))return(0,u.isSequentialAgent)(e)?`${e.name} (Sequential Agent)`:(0,u.isLoopAgent)(e)?`${e.name} (Loop Agent)`:(0,u.isParallelAgent)(e)?`${e.name} (Parallel Agent)`:e.name;if((0,u.isBaseTool)(e))return e.name;throw new Error(`Unsupported tool type: ${e}`)}function gt(e){return(0,u.isBaseAgent)(e)?`\u{1F916} ${e.name}`:(0,u.isFunctionTool)(e)?`\u{1F527} ${e.name}`:(0,u.isAgentTool)(e)?`\u{1F916} ${e.name}`:(0,u.isBaseTool)(e)?`\u{1F527} ${e.name}`:(console.warn(`Unsupported tool type: ${typeof e}`),`\u2753 Unsupported tool type: ${typeof e}`)}function mt(e){return(0,u.isBaseAgent)(e)?"ellipse":(0,u.isFunctionTool)(e)||(0,u.isBaseTool)(e)?"box":(console.warn(`Unsupported tool type: ${typeof e}`),"cylinder")}function se(e){return!!((0,u.isSequentialAgent)(e)||(0,u.isLoopAgent)(e)||(0,u.isParallelAgent)(e))}async function ft(e,t){let s=new h.Digraph(e.name,!0,{rankdir:"LR",bgcolor:"#333537"});return await M(s,e,t),s}async function re(e,t){let s=await ft(e,t);return(0,h.toDot)(s)}var Y=class{constructor(t){this.runnerCache={};this.traceDict={};this.sessionTraceDict={};var s,r,n,o,a,i,c,l;this.host=(s=t.host)!=null?s:"localhost",this.port=(r=t.port)!=null?r:8e3,this.sessionService=(n=t.sessionService)!=null?n:new y.InMemorySessionService,this.memoryService=(o=t.memoryService)!=null?o:new y.InMemoryMemoryService,this.artifactService=(a=t.artifactService)!=null?a:new y.InMemoryArtifactService,this.agentLoader=(i=t.agentLoader)!=null?i:new B(t.agentsDir),this.serveDebugUI=(c=t.serveDebugUI)!=null?c:!1,this.allowOrigins=t.allowOrigins,this.otelToCloud=(l=t.otelToCloud)!=null?l:!1,this.registerProcessors=t.registerProcessors,this.memoryExporter=new te(this.sessionTraceDict),this.app=(0,V.default)(),this.init()}async setupTelemetry(){let t=[new fe.SimpleSpanProcessor(new ee(this.traceDict)),new fe.SimpleSpanProcessor(this.memoryExporter)];if(await Le(this.otelToCloud,t),this.registerProcessors){let s=Be.trace.getTracerProvider();this.registerProcessors(s)}}init(){let t=this.app;this.setupTelemetry(),this.serveDebugUI&&(t.get("/",(s,r)=>{r.redirect("/dev-ui")}),t.use("/dev-ui",V.default.static(Me.join(__dirname,"../browser"),{setHeaders:(s,r)=>{r.endsWith(".js")&&s.setHeader("Content-Type","text/javascript")}}))),this.allowOrigins&&t.use((0,Ue.default)({origin:this.allowOrigins})),t.use(V.default.urlencoded({limit:"50mb",extended:!0})),t.use(V.default.json({limit:"50mb"})),t.get("/list-apps",async(s,r)=>{try{let n=await this.agentLoader.listAgents();r.json(n)}catch(n){r.status(500).json({error:n.message})}}),t.get("/debug/trace/:eventId",(s,r)=>{let n=s.params.eventId,o=this.traceDict[n];return o?r.json(o):r.status(404).json({error:"Trace not found"})}),t.get("/debug/trace/session/:sessionId",(s,r)=>{let n=s.params.sessionId,o=this.memoryExporter.getFinishedSpans(n);if(o.length===0)return r.json([]);let a=o.map(i=>{var c;return{name:i.name,span_id:i.spanContext().spanId,trace_id:i.spanContext().traceId,start_time:pe(i.startTime),end_time:pe(i.endTime),attributes:{...i.attributes},parent_span_id:((c=i.parentSpanContext)==null?void 0:c.spanId)||null}});return r.json(a)}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/events/:eventId/graph",async(s,r)=>{try{var n=[];try{let l=s.params.appName;let d=s.params.userId;let w=s.params.sessionId;let p=s.params.eventId;let m=await this.sessionService.getSession({appName:l,userId:d,sessionId:w});if(!m){r.status(404).json({error:`Session not found: ${w}`});return}let _=m.events||[];let g=_.find(F=>F.id===p);if(!g){r.status(404).json({error:`Event not found: ${p}`});return}let b=(0,y.getFunctionCalls)(g);let T=(0,y.getFunctionResponses)(g);let j=D(n,await this.agentLoader.getAgentFile(l),!0);let le=await j.load();if(b.length>0){let F=[];for(let ue of b)F.push([g.author,ue.name]);return r.send({dotSrc:await re(le,F)})}if(T.length>0){let F=[];for(let ue of T)F.push([ue.name,g.author]);return r.send({dotSrc:await re(le,F)})}return r.send({dotSrc:await re(le,[[g.author,""]])})}catch(o){var a=o,i=!0}finally{var c=L(n,a,i);c&&await c}}catch(l){r.status(500).json({error:l.message});return}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId,i=await this.sessionService.getSession({appName:n,userId:o,sessionId:a});if(!i){r.status(404).json({error:`Session not found: ${a}`});return}r.json(i)}catch(n){r.status(500).json({error:n.message})}}),t.get("/apps/:appName/users/:userId/sessions",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=await this.sessionService.listSessions({appName:n,userId:o});r.json(a)}catch(n){r.status(500).json({error:n.message})}}),t.post("/apps/:appName/users/:userId/sessions/:sessionId",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId;if(await this.sessionService.getSession({appName:n,userId:o,sessionId:a})){r.status(400).json({error:`Session already exists: ${a}`});return}let c=await this.sessionService.createSession({appName:n,userId:o,state:{},sessionId:a});r.json(c)}catch(n){r.status(500).json({error:n.message})}}),t.post("/apps/:appName/users/:userId/sessions",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=await this.sessionService.createSession({appName:n,userId:o});r.json(a)}catch(n){r.status(500).json({error:n.message})}}),t.delete("/apps/:appName/users/:userId/sessions/:sessionId",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId;if(!await this.sessionService.getSession({appName:n,userId:o,sessionId:a})){r.status(404).json({error:`Session not found: ${a}`});return}await this.sessionService.deleteSession({appName:n,userId:o,sessionId:a}),r.status(204).json({})}catch(n){r.status(500).json({error:n.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId,i=s.params.artifactName,c=await this.artifactService.loadArtifact({appName:n,userId:o,sessionId:a,filename:i});if(!c){r.status(404).json({error:`Artifact not found: ${i}`});return}r.json(c)}catch(n){r.status(500).json({error:n.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName/versions/:versionId",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId,i=s.params.artifactName,c=s.params.versionId,l=await this.artifactService.loadArtifact({appName:n,userId:o,sessionId:a,filename:i,version:parseInt(c,10)});if(!l){r.status(404).json({error:`Artifact not found: ${i}`});return}r.json(l)}catch(n){r.status(500).json({error:n.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId,i=await this.artifactService.listArtifactKeys({appName:n,userId:o,sessionId:a});r.json(i)}catch(n){r.status(500).json({error:n.message})}}),t.get("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName/versions",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId,i=s.params.artifactName,c=await this.artifactService.listVersions({appName:n,userId:o,sessionId:a,filename:i});r.json(c)}catch(n){r.status(500).json({error:n.message})}}),t.delete("/apps/:appName/users/:userId/sessions/:sessionId/artifacts/:artifactName",async(s,r)=>{try{let n=s.params.appName,o=s.params.userId,a=s.params.sessionId,i=s.params.artifactName;await this.artifactService.deleteArtifact({appName:n,userId:o,sessionId:a,filename:i}),r.status(204).json({})}catch(n){r.status(500).json({error:n.message})}}),t.post("/apps/:appName/eval_sets/:evalSetId",(s,r)=>r.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_sets",(s,r)=>r.status(501).json({error:"Not implemented"})),t.post("/apps/:appName/eval_sets/:evalSetId/add_session",(s,r)=>r.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_sets/:evalSetId/evals",(s,r)=>r.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_sets/:evalSetId/evals/:evalCaseId",(s,r)=>r.status(501).json({error:"Not implemented"})),t.put("/apps/:appName/eval_sets/:evalSetId/evals/:evalCaseId",(s,r)=>r.status(501).json({error:"Not implemented"})),t.delete("/apps/:appName/eval_sets/:evalSetId/evals/:evalCaseId",(s,r)=>r.status(501).json({error:"Not implemented"})),t.post("/apps/:appName/eval_sets/:evalSetId/run_eval",(s,r)=>r.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_results/:evalResultId",(s,r)=>r.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_results",(s,r)=>r.status(501).json({error:"Not implemented"})),t.get("/apps/:appName/eval_metrics",(s,r)=>r.status(501).json({error:"Not implemented"})),t.post("/run",async(s,r)=>{let{appName:n,userId:o,sessionId:a,newMessage:i}=s.body;if(!await this.sessionService.getSession({appName:n,userId:o,sessionId:a})){r.status(404).json({error:`Session not found: ${a}`});return}try{var l=[];try{let _=D(l,await this.agentLoader.getAgentFile(n),!0);let g=await _.load();let b=await this.getRunner(g,n);let T=[];for await(let j of b.runAsync({userId:o,sessionId:a,newMessage:i}))T.push(j);r.json(T)}catch(d){var w=d,p=!0}finally{var m=L(l,w,p);m&&await m}}catch(_){r.status(500).json({error:_.message})}}),t.post("/run_sse",async(s,r)=>{let{appName:n,userId:o,sessionId:a,newMessage:i,streaming:c}=s.body;if(!await this.sessionService.getSession({appName:n,userId:o,sessionId:a})){r.status(404).json({error:`Session not found: ${a}`});return}try{var d=[];try{let g=D(d,await this.agentLoader.getAgentFile(n),!0);let b=await g.load();let T=await this.getRunner(b,n);r.setHeader("Cache-Control","no-cache");r.setHeader("Content-Type","text/event-stream");r.setHeader("Access-Control-Allow-Origin","*");r.setHeader("Connection","keep-alive");r.flushHeaders();for await(let j of T.runAsync({userId:o,sessionId:a,newMessage:i,runConfig:{streamingMode:c?y.StreamingMode.SSE:y.StreamingMode.NONE}}))r.write(`data: ${JSON.stringify(j)}

`);r.end()}catch(w){var p=w,m=!0}finally{var _=L(d,p,m);_&&await _}}catch(g){r.headersSent?r.end(`data: ${JSON.stringify({error:g.message})}

`):r.status(500).json({error:g.message})}})}start(){return new Promise(t=>{this.server=this.app.listen(this.port,()=>{let s=`${this.host}:${this.port}`;console.log(`
+-----------------------------------------------------------------------------+
| ADK Web Server started                                                      |
|                                                                             |
| For local testing, access at http://${s}.${"".padStart(39-s.length)}|
+-----------------------------------------------------------------------------+`),t()})})}stop(){return this.server?new Promise((t,s)=>{this.server.close(r=>{if(r){s(r);return}console.log(`
+-----------------------------------------------------------------------------+
| ADK Web Server stopped                                                      |
+-----------------------------------------------------------------------------+`),t()})}):Promise.resolve()}async getRunner(t,s){return s in this.runnerCache||(this.runnerCache[s]=new y.Runner({appName:s,agent:t,memoryService:this.memoryService,sessionService:this.sessionService,artifactService:this.artifactService})),this.runnerCache[s]}};var v=require("@clack/prompts"),J=require("child_process"),x=f(require("path")),He=require("util");var qe=(0,He.promisify)(J.exec),Ke=process.cwd(),ht=`{
  "compilerOptions": {
    "target": "esnext",
    "module": "nodenext",
    "rootDir": "./",
    "outDir": "dist",
    "allowUnreachableCode": false,
    "allowUnusedLabels": false,
    "declaration": true,
    "declarationMap": true,
    "esModuleInterop": true,
    "exactOptionalPropertyTypes": true,
    "noEmitOnError": true,
    "noFallthroughCasesInSwitch": true,
    "noImplicitReturns": true,
    "noUncheckedIndexedAccess": true,
    "pretty": true,
    "skipLibCheck": true,
    "sourceMap": true,
    "strict": true
  }
}
`.trim(),vt=(e,t)=>`
{
  "name": "${e}",
  "version": "1.0.0",
  "description": "",
  "main": "agent.${t}",
  "scripts": {
    "web": "npx @google/adk-devtools web",
    "cli": "npx @google/adk-devtools run agent.${t}"
  },
  "keywords": [],
  "author": "",
  "license": "ISC"
}
`.trim(),wt=e=>`
import {FunctionTool, LlmAgent} from '@google/adk';
import {z} from 'zod';
import dotenv from 'dotenv';

dotenv.config();

/* Mock tool implementation */
const getCurrentTime = new FunctionTool({
  name: 'get_current_time',
  description: 'Returns the current time in a specified city.',
  parameters: z.object({
    city: z.string().describe("The name of the city for which to retrieve the current time."),
  }),
  execute: ({city}) => {
    return {status: 'success', report: \`The current time in \${city} is 10:30 AM\`};
  },
});

export const rootAgent = new LlmAgent({
  name: 'hello_time_agent',
  model: '${e}',
  description: 'Tells the current time in a specified city.',
  instruction: \`You are a helpful assistant that tells the current time in a city.
                Use the 'getCurrentTime' tool for this purpose.\`,
  tools: [getCurrentTime],
});
`.trim();async function yt(){if(process.env.GOOGLE_CLOUD_PROJECT)return process.env.GOOGLE_CLOUD_PROJECT;try{return(0,J.execSync)("gcloud config get-value project",{encoding:"utf-8",stdio:"pipe"}).trim()}catch{return""}}async function St(){if(process.env.GOOGLE_CLOUD_LOCATION)return process.env.GOOGLE_CLOUD_LOCATION;try{return(0,J.execSync)("gcloud config get-value compute/region",{encoding:"utf-8",stdio:"pipe"}).trim()}catch{return""}}async function It(e,t){if(!await H(e))return await de(e);let s=t?!0:await(0,v.select)({message:`Folder ${e} already exists. Would you like to overwrite existing folder?`,options:[{label:"Yes",value:!0},{label:"No",value:!1}]});(0,v.isCancel)(s)&&process.exit(0),s||(console.error(`Agent directory ${e} already exists.`),process.exit(0)),await Ne(e),await de(e)}function At(e){let t=[];return e.apiKey&&(t.push(`GOOGLE_API_KEY=${e.apiKey}`),t.push("GOOGLE_GENAI_USE_VERTEXAI=0")),e.project&&t.push(`GOOGLE_CLOUD_PROJECT=${e.project}`),e.region&&t.push(`GOOGLE_CLOUD_LOCATION=${e.region}`),e.region&&e.project&&t.push("GOOGLE_GENAI_USE_VERTEXAI=1"),t.join(`
`)}async function _t(e){let t=x.join(Ke,e.agentName);await R(x.join(t,`agent.${e.language}`),wt(e.model||"gemini-2.5-flash")),await R(x.join(t,".env"),At(e)),await R(x.join(t,"package.json"),vt(e.agentName,e.language)),e.language==="ts"&&await R(x.join(t,"tsconfig.json"),ht)}async function Ve(e){let t=x.join(Ke,e.agentName);if(await It(t,e.forceYes),!e.model){let r=e.forceYes?"gemini-2.5-flash":await(0,v.select)({message:"Choose a model for the root agent",options:[{label:"gemini-2.5-flash",value:"gemini-2.5-flash"},{label:"gemini-2.5-pro",value:"gemini-2.5-pro"},{label:"gemini-3-flash-preview",value:"gemini-3-flash-preview"},{label:"gemini-3-pro-preview",value:"gemini-3-pro-preview"}]});(0,v.isCancel)(r)&&process.exit(0),e.model=r}if(e.language!=="js"&&e.language!=="ts"){let r=e.forceYes?"ts":await(0,v.select)({message:"Choose a language for the agent",options:[{label:"TypeScript",value:"ts"},{label:"JavaScript",value:"js"}]});(0,v.isCancel)(r)&&process.exit(0),e.language=r}if(!e.apiKey&&!e.project){let r=e.forceYes?"googleai":await(0,v.select)({message:"Choose a backend",options:[{label:"Google AI",value:"googleai"},{label:"Vertex AI",value:"vertex"}]});if((0,v.isCancel)(r)&&process.exit(0),r==="vertex"){let n=await yt(),o=await St(),a=e.forceYes?n:(await(0,v.text)({message:"Enter the Google Cloud Project ID",initialValue:n})).toString();(0,v.isCancel)(a)&&process.exit(0),e.project=a;let i=e.forceYes?o:await(0,v.text)({message:"Enter the Google Cloud Region",initialValue:o});(0,v.isCancel)(i)&&process.exit(0),e.region=i}else{let n=e.forceYes?"":await(0,v.text)({message:"Enter the Google API Key"});(0,v.isCancel)(n)&&process.exit(0),e.apiKey=n}}await _t(e),e.language==="ts"&&await qe("npm install typescript --save-dev",{cwd:t}),await qe("npm install @google/adk @google/adk-devtools zod dotenv",{cwd:t});let s=await Ee(t);console.log(`
Created the following files in ${t}:`),s.forEach(r=>{console.log(`  - ${r}`)}),console.log(`Run 'cd ${e.agentName} && npm run web' to start the agent in a web interface`)}var ne=require("child_process"),k=f(require("fs/promises")),I=f(require("path")),he=require("util");var bt=(0,he.promisify)(ne.exec),Ot=(0,he.promisify)(ne.spawn),Rt=["@google/adk"];function Pt(e,t){let s=new Set;for(let n of e)if(n.startsWith("--")){let o=n.split("=")[0];s.add(o)}let r=t.filter(n=>s.has(n)).sort();if(r.length)throw new Error(`The argument(s) ${r.join(", ")} conflict with ADK's automatic configuration. ADK will set these arguments automatically, so please remove them from your command.`)}async function Tt(e,t){let s=await e.listAgents();for(let r of s){let n=await e.getAgentFile(r),o=I.parse(n.getFilePath()).base;await k.cp(n.getFilePath(),I.join(t,o))}}function Nt(e){var i;let t=e.region?["--region",e.region]:[],s=["--source","--project","--port","--verbosity"];e.region&&s.push("--region"),e.extraGcloudArgs&&Pt(e.extraGcloudArgs,s);let r=["run","deploy",e.serviceName,"--source",e.tempFolder,"--project",e.project,...t,"--port",e.port.toString(),"--verbosity",e.logLevel.toLowerCase()],n=[],o=[];if((i=e.extraGcloudArgs)!=null&&i.length)for(let c of e.extraGcloudArgs)c==="--labels"?n.push(c.slice(9)):o.push(c);let a=["created-by=adk",...n];return r.push("--labels",a.join(",")),r.push(...o),r}async function Et(e,t){let s=await je(e,"package.json",3),r=await K(s);if(!r||!r.dependencies)throw new Error(`No dependencies found in package.json: ${s}`);for(let o of Rt)if(!(o in r.dependencies))throw new Error(`Package "${o}" is required but not found in package.json: ${s}`);let n=I.join(t,"package.json");await Promise.all([k.mkdir(I.join(t,"node_modules")),R(I.join(t,"package-lock.json"),""),R(n,{dependencies:r.dependencies})]),console.info("Creating package.json complete",n)}function jt(e){let t=e.withUi?"web":"api_server",s=[`--port=${e.port}`,"--host=0.0.0.0"];return e.logLevel&&s.push(`--log_level=${e.logLevel}`),e.allowOrigins&&s.push(`--allow_origins=${e.allowOrigins}`),e.artifactServiceUri&&s.push(`--artifact_service_uri=${e.artifactServiceUri}`),e.otelToCloud&&s.push("--otel_to_cloud"),`
FROM node:lts-alpine
WORKDIR /app

# Create a non-root user
RUN adduser --disabled-password --gecos "" myuser

# Switch to the non-root user
USER myuser

# Set up environment variables - Start
ENV PATH="/home/myuser/.local/bin:$PATH"
ENV GOOGLE_GENAI_USE_VERTEXAI=1
ENV GOOGLE_CLOUD_PROJECT=${e.project}
ENV GOOGLE_CLOUD_LOCATION=${e.region}
# Set up environment variables - End

# Copy application files
COPY --chown=myuser:myuser "agents/${e.appName}/" "/app/agents/${e.appName}/"
COPY --chown=myuser:myuser "package.json" "/app/package.json"
COPY --chown=myuser:myuser "package-lock.json" "/app/package-lock.json"
COPY --chown=myuser:myuser "node_modules" "/app/node_modules"
# Copy application files

# Install Agent Deps - Start
RUN npm install @google/adk-devtools@latest
RUN npm install --production
# Install Agent Deps - End

EXPOSE ${e.port}

CMD npx adk ${t} /app/agents/${e.appName} ${s.join(" ")}`}async function Ye(e){let{stdout:t}=await bt("gcloud config get-value "+e);return t.trim()}async function Ft(e,t){let s=I.join(e,"Dockerfile");await R(s,jt(t)),console.info("Creating Dockerfile complete:",s)}async function Je(e){let t=e.project||await Ye("project");if(!t||t==="(unset)")throw new Error('Project is not specified and default value for "project" is not set in gcloud config. Please specify region with --project option or set default value running "gcloud config set project YOUR_PROJECT".');e.project||(e.project=t,console.info("--project option is not provided, using default project from gcloud config:",t));let s=e.region||await Ye("run/region");if(!s)throw new Error('Region is not specified and default value for "run/region" is not set in gcloud config. Please specify region with --region option or set default value running "gcloud config set run/region YOUR_REGION".');e.region||(e.region=s,console.info("--region option is not provided, using default region from gcloud config:",s));let r=Nt(e),n=new B(e.agentPath,{bundle:"any"}),o=await z(e.agentPath),a=o?I.dirname(e.agentPath):e.agentPath,i=e.appName||o?I.parse(e.agentPath).name:I.basename(e.agentPath);console.info("Starting deployment to Cloud Run..."),await H(e.tempFolder)&&(console.info("Cleaning up existing temporary files..."),await k.rm(e.tempFolder,{recursive:!0,force:!0}));try{console.info("Copying agent source files..."),await Tt(n,I.join(e.tempFolder,"agents",i)),console.info("Creating package.json..."),await Et(a,e.tempFolder),console.info("Creating Dockerfile..."),await Ft(e.tempFolder,{appName:i,project:e.project,region:e.region,port:e.port,withUi:e.withUi,logLevel:e.logLevel,allowOrigins:e.allowOrigins,otelToCloud:e.otelToCloud}),console.info("Deploying to Cloud Run..."),await Ot("gcloud",r,{stdio:"inherit"})}catch(c){console.error("\x1B[31mFailed to deploy to Cloud Run:",c.message,"\x1B[0m")}finally{console.info("Cleaning up temporary files..."),await k.rm(e.tempFolder,{recursive:!0,force:!0}),await n.disposeAll(),console.info("Temporary files cleaned up.")}}var N=require("@google/adk"),W=f(require("path")),Xe=f(require("readline"));var ve=process.cwd();async function ze(e){let t=Xe.createInterface({input:process.stdin,output:process.stdout});return new Promise(s=>{t.question(e,r=>{t.close(),s(r)})})}async function Ct(e){let t=await K(W.join(ve,e.filePath));if(!t)return;t.state._time=new Date().toISOString();let s=await e.sessionService.createSession({appName:e.appName,userId:e.userId,state:t.state}),r=new N.Runner(e);for(let n of t.queries){console.log(`[user]: ${n}`);let o={userId:s.userId,sessionId:s.id,newMessage:{role:"user",parts:[{text:n}]}};for await(let a of r.runAsync(o))if(a.content&&a.content.parts){let i=a.content.parts.map(c=>c.text||"").join("");i&&console.log(`[${a.author}]: ${i}`)}}return s}async function We(e){let t=new N.Runner({appName:e.rootAgent.name,agent:e.rootAgent,artifactService:e.artifactService,sessionService:e.sessionService,memoryService:e.memoryService});for(;;){let s=await ze("[user]: ");if(!(!s||!s.trim())){if(s==="exit")break;for await(let r of t.runAsync({userId:e.session.userId,sessionId:e.session.id,newMessage:{role:"user",parts:[{text:s}]}}))if(r.content&&r.content.parts){let n=r.content.parts.map(o=>o.text||"").join("");n&&console.log(`[${r.author}]: ${n}`)}}}}async function Qe(e){var t;try{var s=[];try{let i="test_user";let c=e.artifactService||new N.InMemoryArtifactService;let l=e.sessionService||new N.InMemorySessionService;let d=e.memoryService||new N.InMemoryMemoryService;let w=D(s,new G(W.join(ve,e.agentPath)),!0);let p=await w.load();let m=await l.createSession({appName:p.name,userId:i});if(e.inputFile)m=await Ct({appName:p.name,userId:i,agent:p,artifactService:c,sessionService:l,memoryService:d,filePath:e.inputFile})||m;else if(e.savedSessionFile){let _=await K(e.savedSessionFile);if(_)for(let g of _.events){await l.appendEvent({session:m,event:g});let b=g.content;if(b&&((t=b.parts)!=null&&t.length)){let T=b.parts.map(j=>j.text||"").join("");T&&console.log(`[${g.author}]: ${T}`)}}await We({rootAgent:p,artifactService:c,sessionService:l,memoryService:d,session:m})}else console.log(`Running agent ${p.name}, type exit to exit.`),await We({rootAgent:p,artifactService:c,sessionService:l,memoryService:d,session:m});if(e.saveSession){let _=e.sessionId||await ze("Session ID to save: "),g=W.join(e.agentPath,`${_}.session.json`),b=await l.getSession({appName:m.appName,userId:m.userId,sessionId:m.id});await R(W.join(ve,g),b),console.log("Session saved to",g)}}catch(r){var n=r,o=!0}finally{var a=L(s,n,o);a&&await a}}catch(i){console.log(i)}}Ze.default.config();var xt={debug:A.LogLevel.DEBUG,info:A.LogLevel.INFO,warn:A.LogLevel.WARN,error:A.LogLevel.ERROR};function we(e){return e.verbose?A.LogLevel.DEBUG:typeof e.log_level=="string"?xt[e.log_level.toLowerCase()]||A.LogLevel.INFO:A.LogLevel.INFO}function ye(e){return oe.isAbsolute(e)?e:oe.join(process.cwd(),e)}function Se(e){if(e.startsWith("gs://")){let t=e.split("://")[1];return new A.GcsArtifactService(t)}throw new Error(`Unsupported artifact service URI: ${e}`)}var Ie=new O.Argument("[agents_dir]","Agent file or directory of agents to serve. For directory the internal structure should be agents_dir/{agentName}.js or agents_dir/{agentName}/agent.js. Agent file should has export of the rootAgent as instance of BaseAgent (e.g LlmAgent)").default(process.cwd()),tt=new O.Option("-h, --host <string>","Optional. The binding host of the server").default(et.hostname()),Ae=new O.Option("-p, --port <number>","Optional. The port of the server").default("8000"),_e=new O.Option("--allow_origins <string>","Optional. The allow origins of the server").default(""),ae=new O.Option("-v, --verbose [boolean]","Optional. The verbose level of the server").default(!1),ie=new O.Option("--log_level <string>","Optional. The log level of the server").default("info"),ce=new O.Option("--artifact_service_uri <string>, Optional. The URI of the artifact service, supported URIs: gs://<bucket name> for GCS artifact service."),be=new O.Option("--otel_to_cloud [boolean]","Optional. Whether to send otel traces to cloud.").default(!1),q=new O.Command("ADK CLI");q.command("web").description("Start ADK web server").addArgument(Ie).addOption(tt).addOption(Ae).addOption(_e).addOption(ae).addOption(ie).addOption(ce).addOption(be).action((e,t)=>{(0,A.setLogLevel)(we(t)),new Y({agentsDir:ye(e),host:t.host,port:parseInt(t.port,10),serveDebugUI:!0,allowOrigins:t.allow_origins,artifactService:t.artifact_service_uri?Se(t.artifact_service_uri):void 0,otelToCloud:!!t.otel_to_cloud}).start()});q.command("api_server").description("Start ADK API server").addArgument(Ie).addOption(tt).addOption(Ae).addOption(_e).addOption(ae).addOption(ie).addOption(ce).addOption(be).action((e,t)=>{(0,A.setLogLevel)(we(t)),new Y({agentsDir:ye(e),host:t.host,port:parseInt(t.port,10),serveDebugUI:!1,allowOrigins:t.allow_origins,artifactService:t.artifact_service_uri?Se(t.artifact_service_uri):void 0,otelToCloud:!!t.otel_to_cloud}).start()});q.command("create").description("Creates a new agent").argument("[agent]","Name to give the new agent","adk_agent").option("-y, --yes","Optional. Skip confirmation prompts.").option("--model <string>","Optional. THe model used for the root_agent").option("--api_key <string>","Optional. The API Key needed to access the model, e.g. Google AI API Key.").option("--project <string>","Optional. The Google Cloud Project for using VertexAI as backend.").option("--region <string>","Optional. The Google Cloud Region for using VertexAI as backend.").option("--language <string>","Optional. Either ts or js as the language to output.").action((e,t)=>{Ve({agentName:e,forceYes:!!t.yes,model:t.model,apiKey:t.api_key,project:t.project,region:t.region,language:t.language})});q.command("run").description("Runs agent").argument("<agent>","Agent file path (.js or .ts)").option("--save_session [boolean]","Optional. Whether to save the session to a json file on exit.",!1).option("--session_id <string>","Optional. The session ID to save the session to on exit when --save_session is set to true. User will be prompted to enter a session ID if not set.").option("--replay <string>","The json file that contains the initial state of the session and user queries. A new session will be created using this state. And user queries are run against the newly created session. Users cannot continue to interact with the agent.").option("--resume <string>","The json file that contains a previously saved session (by --save_session option). The previous session will be re-displayed. And user can continue to interact with the agent.").addOption(ae).addOption(ie).addOption(ce).addOption(be).action((e,t)=>{(0,A.setLogLevel)(we(t)),Qe({agentPath:e,inputFile:t.replay,savedSessionFile:t.resume,saveSession:!!t.save_session,sessionId:t.session_id,artifactService:t.artifact_service_uri?Se(t.artifact_service_uri):void 0,otelToCloud:!!t.otel_to_cloud})});var kt=q.command("deploy").description("Deploy agent").allowUnknownOption().allowExcessArguments();kt.command("cloud_run").addArgument(Ie).addOption(Ae).option("--project [string]","Optional. Google Cloud project to deploy the agent. If not set, default project from gcloud config is used").option("--region [string]","Optional. Google Cloud region to deploy the agent. If not set, default run/region from gcloud config is used").option("--service_name [string]",'Optional. The service name to use in Cloud Run. Default: "adk-default-service-name"',"adk-default-service-name").option("--temp_folder [string]","Optional. Temp folder for the generated Cloud Run source files (default: a timestamped folder in the system temp directory).",Q("cloud_run_deploy_src")).option("--adk_version [string]","Optional. ADK version to use in the Cloud Run service. If not set, default to the latest version available on npm","latest").option("--with_ui [boolean]","Optional. Deploy ADK Web UI if set. (default: deploy ADK API server only)",!1).addOption(_e).addOption(ae).addOption(ie).addOption(ce).action((e,t)=>{let s=[];for(let r of process.argv.slice(5)){let n=r.replace(/^-+/,"");n.includes("=")&&(n=n.split("=")[0]),!(n in t)&&s.push(r)}Je({agentPath:ye(e),project:t.project,region:t.region,serviceName:t.service_name,tempFolder:t.temp_folder,port:parseInt(t.port,10),withUi:!!t.with_ui,logLevel:t.log_level,adkVersion:t.adk_version,allowOrigins:t.allow_origins,extraGcloudArgs:s,artifactServiceUri:t.artifact_service_uri})});q.parse(process.argv);
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
