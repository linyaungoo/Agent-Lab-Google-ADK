/**
  * @license
  * Copyright 2025 Google LLC
  * SPDX-License-Identifier: Apache-2.0
  */

var Co=Object.defineProperty,vo=Object.defineProperties;var Ao=Object.getOwnPropertyDescriptors;var be=Object.getOwnPropertySymbols;var Jt=Object.prototype.hasOwnProperty,Wt=Object.prototype.propertyIsEnumerable;var te=(n,e)=>(e=Symbol[n])?e:Symbol.for("Symbol."+n),xo=n=>{throw TypeError(n)};var Zt=(n,e,t)=>e in n?Co(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,E=(n,e)=>{for(var t in e||(e={}))Jt.call(e,t)&&Zt(n,t,e[t]);if(be)for(var t of be(e))Wt.call(e,t)&&Zt(n,t,e[t]);return n},ne=(n,e)=>vo(n,Ao(e));var Yt=(n,e)=>{var t={};for(var o in n)Jt.call(n,o)&&e.indexOf(o)<0&&(t[o]=n[o]);if(n!=null&&be)for(var o of be(n))e.indexOf(o)<0&&Wt.call(n,o)&&(t[o]=n[o]);return t};var f=function(n,e){this[0]=n,this[1]=e},m=(n,e,t)=>{var o=(s,a,c,l)=>{try{var u=t[s](a),d=(a=u.value)instanceof f,p=u.done;Promise.resolve(d?a[0]:a).then(C=>d?o(s==="return"?s:"next",a[1]?{done:C.done,value:C.value}:C,c,l):c({value:C,done:p})).catch(C=>o("throw",C,c,l))}catch(C){l(C)}},r=s=>i[s]=a=>new Promise((c,l)=>o(s,a,c,l)),i={};return t=t.apply(n,e),i[te("asyncIterator")]=()=>i,r("next"),r("throw"),r("return"),i},z=n=>{var e=n[te("asyncIterator")],t=!1,o,r={};return e==null?(e=n[te("iterator")](),o=i=>r[i]=s=>e[i](s)):(e=e.call(n),o=i=>r[i]=s=>{if(t){if(t=!1,i==="throw")throw s;return s}return t=!0,{done:!1,value:new f(new Promise(a=>{var c=e[i](s);c instanceof Object||xo("Object expected"),a(c)}),1)}}),r[te("iterator")]=()=>r,o("next"),"throw"in e?o("throw"):r.throw=i=>{throw i},"return"in e&&o("return"),r},y=(n,e,t)=>(e=n[te("asyncIterator")])?e.call(n):(n=n[te("iterator")](),e={},t=(o,r)=>(r=n[o])&&(e[o]=i=>new Promise((s,a,c)=>(i=r.call(n,i),c=i.done,Promise.resolve(i.value).then(l=>s({value:l,done:c}),a)))),t("next"),t("return"),e);var qe=class{constructor(e={}){this.task=e.task,this.stream=e.stream}};import{context as fn,trace as dn}from"@opentelemetry/api";function F(n={}){return E({stateDelta:{},artifactDelta:{},requestedAuthConfigs:{},requestedToolConfirmations:{}},n)}function Qt(n,e){let t=F();e&&Object.assign(t,e);for(let o of n)o&&(o.stateDelta&&Object.assign(t.stateDelta,o.stateDelta),o.artifactDelta&&Object.assign(t.artifactDelta,o.artifactDelta),o.requestedAuthConfigs&&Object.assign(t.requestedAuthConfigs,o.requestedAuthConfigs),o.requestedToolConfirmations&&Object.assign(t.requestedToolConfirmations,o.requestedToolConfirmations),o.skipSummarization!==void 0&&(t.skipSummarization=o.skipSummarization),o.transferToAgent!==void 0&&(t.transferToAgent=o.transferToAgent),o.escalate!==void 0&&(t.escalate=o.escalate));return t}function S(n={}){return ne(E({},n),{id:n.id||ze(),invocationId:n.invocationId||"",author:n.author,actions:n.actions||F(),longRunningToolIds:n.longRunningToolIds||[],branch:n.branch,timestamp:n.timestamp||Date.now()})}function oe(n){return n.actions.skipSummarization||n.longRunningToolIds&&n.longRunningToolIds.length>0?!0:w(n).length===0&&_(n).length===0&&!n.partial&&!Ht(n)}function w(n){let e=[];if(n.content&&n.content.parts)for(let t of n.content.parts)t.functionCall&&e.push(t.functionCall);return e}function _(n){let e=[];if(n.content&&n.content.parts)for(let t of n.content.parts)t.functionResponse&&e.push(t.functionResponse);return e}function Ht(n){var e;return n.content&&((e=n.content.parts)!=null&&e.length)?n.content.parts[n.content.parts.length-1].codeExecutionResult!==void 0:!1}function yo(n){var e;return(e=n.content)!=null&&e.parts?n.content.parts.map(t=>{var o;return(o=t.text)!=null?o:""}).join(""):""}var Xt="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function ze(){let n="";for(let e=0;e<8;e++)n+=Xt[Math.floor(Math.random()*Xt.length)];return n}import{context as je,trace as pe}from"@opentelemetry/api";var ue="0.3.0";var Eo="gen_ai.agent.description",bo="gen_ai.agent.name",To="gen_ai.conversation.id",Ve="gen_ai.operation.name",en="gen_ai.tool.call.id",tn="gen_ai.tool.description",nn="gen_ai.tool.name",So="gen_ai.tool.type",D=pe.getTracer("gcp.vertex.agent",ue);function fe(n){try{return JSON.stringify(n)}catch(e){return"<not serializable>"}}function on({agent:n,invocationContext:e}){let t=pe.getActiveSpan();t&&t.setAttributes({[Ve]:"invoke_agent",[Eo]:n.description,[bo]:n.name,[To]:e.session.id})}function rn({tool:n,args:e,functionResponseEvent:t}){var s,a;let o=pe.getActiveSpan();if(!o)return;o.setAttributes({[Ve]:"execute_tool",[tn]:n.description||"",[nn]:n.name,[So]:n.constructor.name,"gcp.vertex.agent.llm_request":"{}","gcp.vertex.agent.llm_response":"{}","gcp.vertex.agent.tool_call_args":de()?fe(e):"{}"});let r="<not specified>",i="<not specified>";if((s=t.content)!=null&&s.parts){let l=(a=t.content.parts[0])==null?void 0:a.functionResponse;l!=null&&l.id&&(r=l.id),l!=null&&l.response&&(i=l.response)}(typeof i!="object"||i===null)&&(i={result:i}),o.setAttributes({[en]:r,"gcp.vertex.agent.event_id":t.id,"gcp.vertex.agent.tool_response":de()?fe(i):"{}"})}function sn({responseEventId:n,functionResponseEvent:e}){let t=pe.getActiveSpan();t&&(t.setAttributes({[Ve]:"execute_tool",[nn]:"(merged tools)",[tn]:"(merged tools)",[en]:n,"gcp.vertex.agent.tool_call_args":"N/A","gcp.vertex.agent.event_id":n,"gcp.vertex.agent.llm_request":"{}","gcp.vertex.agent.llm_response":"{}"}),t.setAttribute("gcp.vertex.agent.tool_response",de()?fe(e):"{}"))}function an({invocationContext:n,eventId:e,llmRequest:t,llmResponse:o}){var i,s,a;let r=pe.getActiveSpan();if(r&&(r.setAttributes({"gen_ai.system":"gcp.vertex.agent","gen_ai.request.model":t.model,"gcp.vertex.agent.invocation_id":n.invocationId,"gcp.vertex.agent.session_id":n.session.id,"gcp.vertex.agent.event_id":e,"gcp.vertex.agent.llm_request":de()?fe(Io(t)):"{}"}),(i=t.config)!=null&&i.topP&&r.setAttribute("gen_ai.request.top_p",t.config.topP),((s=t.config)==null?void 0:s.maxOutputTokens)!==void 0&&r.setAttribute("gen_ai.request.max_tokens",t.config.maxOutputTokens),r.setAttribute("gcp.vertex.agent.llm_response",de()?fe(o):"{}"),o.usageMetadata&&r.setAttribute("gen_ai.usage.input_tokens",o.usageMetadata.promptTokenCount||0),(a=o.usageMetadata)!=null&&a.candidatesTokenCount&&r.setAttribute("gen_ai.usage.output_tokens",o.usageMetadata.candidatesTokenCount),o.finishReason)){let c=typeof o.finishReason=="string"?o.finishReason.toLowerCase():String(o.finishReason).toLowerCase();r.setAttribute("gen_ai.response.finish_reasons",[c])}}function Io(n){let e={model:n.model,contents:[]};if(n.config){let t=n.config,{responseSchema:o}=t,r=Yt(t,["responseSchema"]);e.config=r}return e.contents=n.contents.map(o=>{var r;return{role:o.role,parts:((r=o.parts)==null?void 0:r.filter(i=>!i.inlineData))||[]}}),e}function cn(n,e){return{next:je.bind(n,e.next.bind(e)),return:je.bind(n,e.return.bind(e)),throw:je.bind(n,e.throw.bind(e)),[Symbol.asyncIterator](){return cn(n,e[Symbol.asyncIterator]())}}}function j(n,e,t){let o=t.call(e);return cn(n,o)}function de(){let n=process.env.ADK_CAPTURE_MESSAGE_CONTENT_IN_SPANS||"true";return n==="true"||n==="1"}var b=class{constructor(e={},t={}){this.value=e;this.delta=t}get(e,t){return e in this.delta?this.delta[e]:e in this.value?this.value[e]:t}set(e,t){this.value[e]=t,this.delta[e]=t}has(e){return e in this.value||e in this.delta}hasDelta(){return Object.keys(this.delta).length>0}update(e){this.delta=E(E({},this.delta),e),this.value=E(E({},this.value),e)}toRecord(){return E(E({},this.value),this.delta)}};b.APP_PREFIX="app:",b.USER_PREFIX="user:",b.TEMP_PREFIX="temp:";var P=class{constructor(e){this.invocationContext=e}get userContent(){return this.invocationContext.userContent}get invocationId(){return this.invocationContext.invocationId}get agentName(){return this.invocationContext.agent.name}get state(){return new b(this.invocationContext.session.state,{})}};var B=class extends P{constructor({invocationContext:e,eventActions:t}){super(e),this.eventActions=t||F(),this._state=new b(e.session.state,this.eventActions.stateDelta)}get state(){return this._state}loadArtifact(e,t){if(!this.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.invocationContext.artifactService.loadArtifact({appName:this.invocationContext.appName,userId:this.invocationContext.userId,sessionId:this.invocationContext.session.id,filename:e,version:t})}async saveArtifact(e,t){if(!this.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");let o=await this.invocationContext.artifactService.saveArtifact({appName:this.invocationContext.appName,userId:this.invocationContext.userId,sessionId:this.invocationContext.session.id,filename:e,artifact:t});return this.eventActions.artifactDelta[e]=o,o}};function Se(){return typeof window<"u"}var Te="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";function re(){let n="";for(let e=0;e<Te.length;e++){let t=Math.random()*16|0;Te[e]==="x"?n+=t.toString(16):Te[e]==="y"?n+=(t&3|8).toString(16):n+=Te[e]}return n}function ln(n){return Se()?window.atob(n):Buffer.from(n,"base64").toString()}var Ke=class{constructor(){this.numberOfLlmCalls=0}incrementAndEnforceLlmCallsLimit(e){if(this.numberOfLlmCalls++,e&&e.maxLlmCalls>0&&this.numberOfLlmCalls>e.maxLlmCalls)throw new Error("Max number of llm calls limit of ".concat(e.maxLlmCalls," exceeded"))}},$=class{constructor(e){this.invocationCostManager=new Ke;this.artifactService=e.artifactService,this.sessionService=e.sessionService,this.memoryService=e.memoryService,this.invocationId=e.invocationId,this.branch=e.branch,this.agent=e.agent,this.userContent=e.userContent,this.session=e.session,this.endInvocation=e.endInvocation||!1,this.transcriptionCache=e.transcriptionCache,this.runConfig=e.runConfig,this.liveRequestQueue=e.liveRequestQueue,this.activeStreamingTools=e.activeStreamingTools,this.pluginManager=e.pluginManager}get appName(){return this.session.appName}get userId(){return this.session.userId}incrementLlmCallCount(){this.invocationCostManager.incrementAndEnforceLlmCallsLimit(this.runConfig)}};function un(){return"e-".concat(re())}var Ze=Symbol.for("google.adk.baseAgent");function Ro(n){return typeof n=="object"&&n!==null&&Ze in n&&n[Ze]===!0}var mn;mn=Ze;var O=class{constructor(e){this[mn]=!0;this.name=wo(e.name),this.description=e.description,this.parentAgent=e.parentAgent,this.subAgents=e.subAgents||[],this.beforeAgentCallback=pn(e.beforeAgentCallback),this.afterAgentCallback=pn(e.afterAgentCallback),this.setParentAgentForSubAgents()}get rootAgent(){return Lo(this)}runAsync(e){return m(this,null,function*(){let t=D.startSpan("invoke_agent ".concat(this.name)),o=dn.setSpan(fn.active(),t);try{yield*z(j(o,this,function(){return m(this,null,function*(){let r=this.createInvocationContext(e),i=yield new f(this.handleBeforeAgentCallback(r));if(i&&(yield i),r.endInvocation)return;on({agent:this,invocationContext:r});try{for(var a=y(this.runAsyncImpl(r)),c,l,u;c=!(l=yield new f(a.next())).done;c=!1){let d=l.value;yield d}}catch(l){u=[l]}finally{try{c&&(l=a.return)&&(yield new f(l.call(a)))}finally{if(u)throw u[0]}}if(r.endInvocation)return;let s=yield new f(this.handleAfterAgentCallback(r));s&&(yield s)})}))}finally{t.end()}})}runLive(e){return m(this,null,function*(){let t=D.startSpan("invoke_agent ".concat(this.name)),o=dn.setSpan(fn.active(),t);try{throw yield*z(j(o,this,function(){return m(this,null,function*(){})})),new Error("Live mode is not implemented yet.")}finally{t.end()}})}findAgent(e){return this.name===e?this:this.findSubAgent(e)}findSubAgent(e){for(let t of this.subAgents){let o=t.findAgent(e);if(o)return o}}createInvocationContext(e){return new $(ne(E({},e),{agent:this}))}async handleBeforeAgentCallback(e){if(this.beforeAgentCallback.length===0)return;let t=new B({invocationContext:e});for(let o of this.beforeAgentCallback){let r=await o(t);if(r)return e.endInvocation=!0,S({invocationId:e.invocationId,author:this.name,branch:e.branch,content:r,actions:t.eventActions})}if(t.state.hasDelta())return S({invocationId:e.invocationId,author:this.name,branch:e.branch,actions:t.eventActions})}async handleAfterAgentCallback(e){if(this.afterAgentCallback.length===0)return;let t=new B({invocationContext:e});for(let o of this.afterAgentCallback){let r=await o(t);if(r)return S({invocationId:e.invocationId,author:this.name,branch:e.branch,content:r,actions:t.eventActions})}if(t.state.hasDelta())return S({invocationId:e.invocationId,author:this.name,branch:e.branch,actions:t.eventActions})}setParentAgentForSubAgents(){for(let e of this.subAgents){if(e.parentAgent)throw new Error('Agent "'.concat(e.name,'" already has a parent agent, current parent: "').concat(e.parentAgent.name,'", trying to add: "').concat(this.name,'"'));e.parentAgent=this}}};function wo(n){if(!ko(n))throw new Error('Found invalid agent name: "'.concat(n,'". Agent name must be a valid identifier. It should start with a letter (a-z, A-Z) or an underscore (_), and can only contain letters, digits (0-9), and underscores.'));if(n==="user")throw new Error("Agent name cannot be 'user'. 'user' is reserved for end-user's input.");return n}function ko(n){return new RegExp("^[\\p{ID_Start}$_][\\p{ID_Continue}$_]*$","u").test(n)}function Lo(n){for(;n.parentAgent;)n=n.parentAgent;return n}function pn(n){return n?Array.isArray(n)?n:[n]:[]}var G=class{},Je=class{};import{createUserContent as Fo}from"@google/genai";import{isEmpty as hn}from"lodash-es";var me=class{constructor(e){this.authConfig=e}getAuthResponse(e){let t="temp:"+this.authConfig.credentialKey;return e.get(t)}generateAuthRequest(){var t,o;let e=this.authConfig.authScheme.type;if(!["oauth2","openIdConnect"].includes(e))return this.authConfig;if((o=(t=this.authConfig.exchangedAuthCredential)==null?void 0:t.oauth2)!=null&&o.authUri)return this.authConfig;if(!this.authConfig.rawAuthCredential)throw new Error("Auth Scheme ".concat(e," requires authCredential."));if(!this.authConfig.rawAuthCredential.oauth2)throw new Error("Auth Scheme ".concat(e," requires oauth2 in authCredential."));if(this.authConfig.rawAuthCredential.oauth2.authUri)return{credentialKey:this.authConfig.credentialKey,authScheme:this.authConfig.authScheme,rawAuthCredential:this.authConfig.rawAuthCredential,exchangedAuthCredential:this.authConfig.rawAuthCredential};if(!this.authConfig.rawAuthCredential.oauth2.clientId||!this.authConfig.rawAuthCredential.oauth2.clientSecret)throw new Error("Auth Scheme ".concat(e," requires both clientId and clientSecret in authCredential.oauth2."));return{credentialKey:this.authConfig.credentialKey,authScheme:this.authConfig.authScheme,rawAuthCredential:this.authConfig.rawAuthCredential,exchangedAuthCredential:this.generateAuthUri()}}generateAuthUri(){return this.authConfig.rawAuthCredential}};var V=class{constructor({hint:e,confirmed:t,payload:o}){this.hint=e!=null?e:"",this.confirmed=t,this.payload=o}};var q=class extends B{constructor(e){super(e),this.functionCallId=e.functionCallId,this.toolConfirmation=e.toolConfirmation}get actions(){return this.eventActions}requestCredential(e){if(!this.functionCallId)throw new Error("functionCallId is not set.");let t=new me(e);this.eventActions.requestedAuthConfigs[this.functionCallId]=t.generateAuthRequest()}getAuthResponse(e){return new me(e).getAuthResponse(this.state)}listArtifacts(){if(!this.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.invocationContext.artifactService.listArtifactKeys({appName:this.invocationContext.session.appName,userId:this.invocationContext.session.userId,sessionId:this.invocationContext.session.id})}searchMemory(e){if(!this.invocationContext.memoryService)throw new Error("Memory service is not initialized.");return this.invocationContext.memoryService.searchMemory({appName:this.invocationContext.session.appName,userId:this.invocationContext.session.userId,query:e})}requestConfirmation({hint:e,payload:t}){if(!this.functionCallId)throw new Error("functionCallId is not set.");this.eventActions.requestedToolConfirmations[this.functionCallId]=new V({hint:e,confirmed:!1,payload:t})}};var gn=(r=>(r[r.DEBUG=0]="DEBUG",r[r.INFO=1]="INFO",r[r.WARN=2]="WARN",r[r.ERROR=3]="ERROR",r))(gn||{}),ie=1;function Po(n){ie=n}var We=class{log(e,...t){if(!(e<ie))switch(e){case 0:this.debug(...t);break;case 1:this.info(...t);break;case 2:this.warn(...t);break;case 3:this.error(...t);break;default:throw new Error("Unsupported log level: ".concat(e))}}debug(...e){ie>0||console.debug(Ie(0),...e)}info(...e){ie>1||console.info(Ie(1),...e)}warn(...e){ie>2||console.warn(Ie(2),...e)}error(...e){ie>3||console.error(Ie(3),...e)}},Ye=class{log(e,...t){}debug(...e){}info(...e){}warn(...e){}error(...e){}},_o={0:"DEBUG",1:"INFO",2:"WARN",3:"ERROR"},Bo={0:"\x1B[34m",1:"\x1B[32m",2:"\x1B[33m",3:"\x1B[31m"},Mo="\x1B[0m";function Ie(n){return"".concat(Bo[n],"[ADK ").concat(_o[n],"]:").concat(Mo)}var K=new We;function Oo(n){K=n!=null?n:new Ye}function No(){return K}var h={log(n,...e){K.log(n,...e)},debug(...n){K.debug(...n)},info(...n){K.info(...n)},warn(...n){K.warn(...n)},error(...n){K.error(...n)}};var Qe="adk-",Re="adk_request_credential",se="adk_request_confirmation",Do={handleFunctionCallList:we,generateAuthEvent:He,generateRequestConfirmationEvent:et};function Xe(){return"".concat(Qe).concat(re())}function Cn(n){let e=w(n);if(e)for(let t of e)t.id||(t.id=Xe())}function vn(n){if(n&&n.parts)for(let e of n.parts)e.functionCall&&e.functionCall.id&&e.functionCall.id.startsWith(Qe)&&(e.functionCall.id=void 0),e.functionResponse&&e.functionResponse.id&&e.functionResponse.id.startsWith(Qe)&&(e.functionResponse.id=void 0)}function An(n,e){let t=new Set;for(let o of n)o.name&&o.name in e&&e[o.name].isLongRunning&&o.id&&t.add(o.id);return t}function He(n,e){var r;if(!((r=e.actions)!=null&&r.requestedAuthConfigs)||hn(e.actions.requestedAuthConfigs))return;let t=[],o=new Set;for(let[i,s]of Object.entries(e.actions.requestedAuthConfigs)){let a={name:Re,args:{function_call_id:i,auth_config:s},id:Xe()};o.add(a.id),t.push({functionCall:a})}return S({invocationId:n.invocationId,author:n.agent.name,branch:n.branch,content:{parts:t,role:e.content.role},longRunningToolIds:Array.from(o)})}function et({invocationContext:n,functionCallEvent:e,functionResponseEvent:t}){var s,a;if(!((s=t.actions)!=null&&s.requestedToolConfirmations)||hn(t.actions.requestedToolConfirmations))return;let o=[],r=new Set,i=w(e);for(let[c,l]of Object.entries(t.actions.requestedToolConfirmations)){let u=(a=i.find(p=>p.id===c))!=null?a:void 0;if(!u)continue;let d={name:se,args:{originalFunctionCall:u,toolConfirmation:l},id:Xe()};r.add(d.id),o.push({functionCall:d})}return S({invocationId:n.invocationId,author:n.agent.name,branch:n.branch,content:{parts:o,role:t.content.role},longRunningToolIds:Array.from(r)})}async function Go(n,e,t){return D.startActiveSpan("execute_tool ".concat(n.name),async o=>{try{h.debug("callToolAsync ".concat(n.name));let r=await n.runAsync({args:e,toolContext:t});return rn({tool:n,args:e,functionResponseEvent:$o(n,r,t,t.invocationContext)}),r}finally{o.end()}})}function $o(n,e,t,o){let r;typeof e!="object"||e==null?r={result:e}:r=e;let s={role:"user",parts:[{functionResponse:{name:n.name,response:r,id:t.functionCallId}}]};return S({invocationId:o.invocationId,author:o.agent.name,content:s,actions:t.actions,branch:o.branch})}async function xn({invocationContext:n,functionCallEvent:e,toolsDict:t,beforeToolCallbacks:o,afterToolCallbacks:r,filters:i,toolConfirmationDict:s}){let a=w(e);return await we({invocationContext:n,functionCalls:a,toolsDict:t,beforeToolCallbacks:o,afterToolCallbacks:r,filters:i,toolConfirmationDict:s})}async function we({invocationContext:n,functionCalls:e,toolsDict:t,beforeToolCallbacks:o,afterToolCallbacks:r,filters:i,toolConfirmationDict:s}){var u;let a=[],c=e.filter(d=>!i||d.id&&i.has(d.id));for(let d of c){let p;s&&d.id&&(p=s[d.id]);let{tool:C,toolContext:v}=Uo({invocationContext:n,functionCall:d,toolsDict:t,toolConfirmation:p});h.debug("execute_tool ".concat(C.name));let x=(u=d.args)!=null?u:{},g=null,A;if(g=await n.pluginManager.runBeforeToolCallback({tool:C,toolArgs:x,toolContext:v}),g==null){for(let T of o)if(g=await T({tool:C,args:x,context:v}),g)break}if(g==null)try{g=await Go(C,x,v)}catch(T){if(T instanceof Error){let k=await n.pluginManager.runOnToolErrorCallback({tool:C,toolArgs:x,toolContext:v,error:T});k?g=k:A=T.message}else A=T}let I=await n.pluginManager.runAfterToolCallback({tool:C,toolArgs:x,toolContext:v,result:g});if(I==null){for(let T of r)if(I=await T({tool:C,args:x,context:v,response:g}),I)break}if(I!=null&&(g=I),C.isLongRunning&&!g)continue;A?g={error:A}:(typeof g!="object"||g==null)&&(g={result:g});let L=S({invocationId:n.invocationId,author:n.agent.name,content:Fo({functionResponse:{id:v.functionCallId,name:C.name,response:g}}),actions:v.actions,branch:n.branch});h.debug("traceToolCall",{tool:C.name,args:x,functionResponseEvent:L.id}),a.push(L)}if(!a.length)return null;let l=qo(a);return a.length>1&&D.startActiveSpan("execute_tool (merged)",d=>{try{h.debug("execute_tool (merged)"),h.debug("traceMergedToolCalls",{responseEventId:l.id,functionResponseEvent:l.id}),sn({responseEventId:l.id,functionResponseEvent:l})}finally{d.end()}}),l}function Uo({invocationContext:n,functionCall:e,toolsDict:t,toolConfirmation:o}){if(!e.name||!(e.name in t))throw new Error("Function ".concat(e.name," is not found in the toolsDict."));let r=new q({invocationContext:n,functionCallId:e.id||void 0,toolConfirmation:o});return{tool:t[e.name],toolContext:r}}function qo(n){if(!n.length)throw new Error("No function response events provided.");if(n.length===1)return n[0];let e=[];for(let i of n)i.content&&i.content.parts&&e.push(...i.content.parts);let t=n[0],o=n.map(i=>i.actions||{}),r=Qt(o);return S({author:t.author,branch:t.branch,content:{role:"user",parts:e},actions:r,timestamp:t.timestamp})}var tt=class{constructor(){this.queue=[];this.resolveFnFifoQueue=[];this.isClosed=!1}send(e){if(this.isClosed)throw new Error("Cannot send to a closed queue.");this.resolveFnFifoQueue.length>0?this.resolveFnFifoQueue.shift()(e):this.queue.push(e)}async get(){return this.queue.length>0?this.queue.shift():this.isClosed?{close:!0}:new Promise(e=>{this.resolveFnFifoQueue.push(e)})}close(){if(this.isClosed)return;for(this.isClosed=!0;this.resolveFnFifoQueue.length>0&&this.queue.length>0;){let t=this.resolveFnFifoQueue.shift(),o=this.queue.shift();t(o)}let e={close:!0};for(;this.resolveFnFifoQueue.length>0;)this.resolveFnFifoQueue.shift()(e)}sendContent(e){this.send({content:e})}sendRealtime(e){this.send({blob:e})}sendActivityStart(){this.send({activityStart:{}})}sendActivityEnd(){this.send({activityEnd:{}})}[Symbol.asyncIterator](){return m(this,null,function*(){for(;;){let e=yield new f(this.get());if(yield e,e.close)break}})}};import{context as yr,trace as Er}from"@opentelemetry/api";import{cloneDeep as Kn}from"lodash-es";import{z as Zn}from"zod";var nt=Symbol.for("google.adk.baseCodeExecutor");function ke(n){return typeof n=="object"&&n!==null&&nt in n&&n[nt]===!0}var yn;yn=nt;var ge=class{constructor(){this[yn]=!0;this.optimizeDataFile=!1;this.stateful=!1;this.errorRetryAttempts=2;this.codeBlockDelimiters=[["```tool_code\n","\n```"],["```python\n","\n```"]];this.executionResultDelimiters=["```tool_output\n","\n```"]}};var zo="^projects/[^/]+/locations/[^/]+/publishers/[^/]+/models/(.+)$";function ot(n){let e=n.match(zo);return e?e[1]:n}function En(n){return ot(n).startsWith("gemini-")}function jo(n){if(!/^\d+(\.\d+)*$/.test(n))return{valid:!1,major:0,minor:0,patch:0};let e=n.split(".").map(t=>parseInt(t,10));return{valid:!0,major:e[0],minor:e.length>1?e[1]:0,patch:e.length>2?e[2]:0}}function bn(n){return ot(n).startsWith("gemini-1")}function he(n){if(!n)return!1;let e=ot(n);if(!e.startsWith("gemini-"))return!1;let t=e.slice(7).split("-",1)[0],o=jo(t);return o.valid&&o.major>=2}var rt=Symbol.for("google.adk.builtInCodeExecutor");function ve(n){return typeof n=="object"&&n!==null&&rt in n&&n[rt]===!0}var Tn,Sn,Ce=class extends(Sn=ge,Tn=rt,Sn){constructor(){super(...arguments);this[Tn]=!0}executeCode(t){return Promise.resolve({stdout:"",stderr:"",outputFiles:[]})}processLlmRequest(t){if(t.model&&he(t.model)){t.config=t.config||{},t.config.tools=t.config.tools||[],t.config.tools.push({codeExecution:{}});return}throw new Error("Gemini code execution tool is not supported for model ".concat(t.model))}};import{Language as Vo,Outcome as In}from"@google/genai";import{cloneDeep as Ko}from"lodash-es";function Rn(n,e){var u;if(!((u=n.parts)!=null&&u.length))return"";for(let d=0;d<n.parts.length;d++){let p=n.parts[d];if(p.executableCode&&(d===n.parts.length-1||!n.parts[d+1].codeExecutionResult))return n.parts=n.parts.slice(0,d+1),p.executableCode.code}let t=n.parts.filter(d=>d.text);if(!t.length)return"";let o=Ko(t[0]),r=t.map(d=>d.text).join("\n"),i=e.map(d=>d[0]).join("|"),s=e.map(d=>d[1]).join("|"),a=new RegExp("?<prefix>.*?)(".concat(i,")(?<codeStr>.*?)(").concat(s,")(?<suffix>.*?)$"),"s").exec(r),{prefix:c,codeStr:l}=(a==null?void 0:a.groups)||{};return l?(n.parts=[],c&&(o.text=c,n.parts.push(o)),n.parts.push(it(l)),l):""}function it(n){return{text:n,executableCode:{code:n,language:Vo.PYTHON}}}function wn(n){if(n.stderr)return{text:n.stderr,codeExecutionResult:{outcome:In.OUTCOME_FAILED}};let e=[];return(n.stdout||!n.outputFiles)&&e.push("Code execution result:\n".concat(n.stdout,"\n")),n.outputFiles&&e.push("Saved artifacts:\n"+n.outputFiles.map(t=>t.name).join(", ")),{text:e.join("\n\n"),codeExecutionResult:{outcome:In.OUTCOME_OK}}}function kn(n,e,t){var r;if(!((r=n.parts)!=null&&r.length))return;let o=n.parts[n.parts.length-1];o.executableCode?n.parts[n.parts.length-1]={text:e[0]+o.executableCode.code+e[1]}:n.parts.length==1&&o.codeExecutionResult&&(n.parts[n.parts.length-1]={text:t[0]+o.codeExecutionResult.output+t[1]},n.role="user")}import{cloneDeep as Zo}from"lodash-es";var st="_code_execution_context",at="execution_session_id",Z="processed_input_files",J="_code_executor_input_files",W="_code_executor_error_counts",ct="_code_execution_results",Ae=class{constructor(e){this.sessionState=e;var t;this.context=(t=e.get(st))!=null?t:{},this.sessionState=e}getStateDelta(){return{[st]:Zo(this.context)}}getExecutionId(){if(at in this.context)return this.context[at]}setExecutionId(e){this.context[at]=e}getProcessedFileNames(){return Z in this.context?this.context[Z]:[]}addProcessedFileNames(e){Z in this.context||(this.context[Z]=[]),this.context[Z].push(...e)}getInputFiles(){return J in this.sessionState?this.sessionState.get(J):[]}addInputFiles(e){J in this.sessionState||this.sessionState.set(J,[]),this.sessionState.get(J).push(...e)}clearInputFiles(){J in this.sessionState&&this.sessionState.set(J,[]),Z in this.context&&(this.context[Z]=[])}getErrorCount(e){return W in this.sessionState&&this.sessionState.get(W)[e]||0}incrementErrorCount(e){W in this.sessionState||this.sessionState.set(W,{}),this.sessionState.get(W)[e]=this.getErrorCount(e)+1}resetErrorCount(e){if(!(W in this.sessionState))return;let t=this.sessionState.get(W);e in t&&delete t[e]}updateCodeExecutionResult({invocationId:e,code:t,resultStdout:o,resultStderr:r}){ct in this.sessionState||this.sessionState.set(ct,{});let i=this.sessionState.get(ct);e in i||(i[e]=[]),i[e].push({code:t,resultStdout:o,resultStderr:r,timestamp:Date.now()})}getCodeExecutionContext(){return this.sessionState.get(st)||{}}};var Jo="google-adk",Wo="gl-typescript",Yo="remote_reasoning_engine",Qo="GOOGLE_CLOUD_AGENT_ENGINE_ID";function Xo(){let n="".concat(Jo,"/").concat(ue);!Se()&&process.env[Qo]&&(n="".concat(n,"+").concat(Yo));let e="".concat(Wo,"/").concat(Se()?window.navigator.userAgent:process.version);return[n,e]}function Ln(){return Xo()}var lt=Symbol.for("google.adk.baseModel");function ut(n){return typeof n=="object"&&n!==null&&lt in n&&n[lt]===!0}var Pn;Pn=lt;var ae=class{constructor({model:e}){this[Pn]=!0;this.model=e}get trackingHeaders(){let t=Ln().join(" ");return{"x-goog-api-client":t,"user-agent":t}}maybeAppendUserContent(e){var t;e.contents.length===0&&e.contents.push({role:"user",parts:[{text:"Handle the requests as specified in the System Instruction."}]}),((t=e.contents[e.contents.length-1])==null?void 0:t.role)!=="user"&&e.contents.push({role:"user",parts:[{text:"Continue processing previous requests as instructed. Exit or provide a summary if no more outputs are needed."}]})}};ae.supportedModels=[];function xe(n,e){n.config||(n.config={});let t=e.join("\n\n");n.config.systemInstruction?n.config.systemInstruction+="\n\n"+t:n.config.systemInstruction=t}function _n(n,e){n.config||(n.config={}),n.config.responseSchema=e,n.config.responseMimeType="application/json"}import{createPartFromText as Mn,FinishReason as er,GoogleGenAI as dt}from"@google/genai";var Le=(t=>(t.VERTEX_AI="VERTEX_AI",t.GEMINI_API="GEMINI_API",t))(Le||{});function Bn(){return Ho("GOOGLE_GENAI_USE_VERTEXAI")?"VERTEX_AI":"GEMINI_API"}function Ho(n){if(!process.env)return!1;let e=(process.env[n]||"").toLowerCase();return["true","1"].includes(e)}var Pe=class{constructor(e){this.geminiSession=e}async sendHistory(e){let t=e.filter(o=>{var r;return o.parts&&((r=o.parts[0])==null?void 0:r.text)});t.length>0?this.geminiSession.sendClientContent({turns:t,turnComplete:t[t.length-1].role==="user"}):h.info("no content is sent")}async sendContent(e){if(!e.parts)throw new Error("Content must have parts.");if(e.parts[0].functionResponse){let t=e.parts.map(o=>o.functionResponse).filter(o=>!!o);h.debug("Sending LLM function response:",t),this.geminiSession.sendToolResponse({functionResponses:t})}else h.debug("Sending LLM new content",e),this.geminiSession.sendClientContent({turns:[e],turnComplete:!0})}async sendRealtime(e){h.debug("Sending LLM Blob:",e),this.geminiSession.sendRealtimeInput({media:e})}buildFullTextResponse(e){return{content:{role:"model",parts:[{text:e}]}}}receive(){return m(this,null,function*(){throw new Error("Not Implemented.")})}async close(){this.geminiSession.close()}};function ft(n){var t;let e=n.usageMetadata;if(n.candidates&&n.candidates.length>0){let o=n.candidates[0];return(t=o.content)!=null&&t.parts&&o.content.parts.length>0?{content:o.content,groundingMetadata:o.groundingMetadata,usageMetadata:e,finishReason:o.finishReason}:{errorCode:o.finishReason,errorMessage:o.finishMessage,usageMetadata:e,finishReason:o.finishReason}}return n.promptFeedback?{errorCode:n.promptFeedback.blockReason,errorMessage:n.promptFeedback.blockReasonMessage,usageMetadata:e}:{errorCode:"UNKNOWN_ERROR",errorMessage:"Unknown error.",usageMetadata:e}}var ce=class extends ae{constructor({model:e,apiKey:t,vertexai:o,project:r,location:i,headers:s}){e||(e="gemini-2.5-flash"),super({model:e}),this.project=r,this.location=i,this.apiKey=t,this.headers=s;let a=typeof process=="object";if(this.vertexai=!!o,!this.vertexai&&a){let c=process.env.GOOGLE_GENAI_USE_VERTEXAI;c&&(this.vertexai=c.toLowerCase()==="true"||c==="1")}if(this.vertexai){if(a&&!this.project&&(this.project=process.env.GOOGLE_CLOUD_PROJECT),a&&!this.location&&(this.location=process.env.GOOGLE_CLOUD_LOCATION),!this.project)throw new Error("VertexAI project must be provided via constructor or GOOGLE_CLOUD_PROJECT environment variable.");if(!this.location)throw new Error("VertexAI location must be provided via constructor or GOOGLE_CLOUD_LOCATION environment variable.")}else if(!this.apiKey&&a&&(this.apiKey=process.env.GOOGLE_GENAI_API_KEY||process.env.GEMINI_API_KEY),!this.apiKey)throw new Error("API key must be provided via constructor or GOOGLE_GENAI_API_KEY or GEMINI_API_KEY environment variable.")}generateContentAsync(e,t=!1){return m(this,null,function*(){var o,r,i,s,d,p,C;if(this.preprocessRequest(e),this.maybeAppendUserContent(e),h.info("Sending out request, model: ".concat(e.model,", backend: ").concat(this.apiBackend,", stream: ").concat(t)),(o=e.config)!=null&&o.httpOptions&&(e.config.httpOptions.headers=E(E({},e.config.httpOptions.headers),this.trackingHeaders)),t){let v=yield new f(this.apiClient.models.generateContentStream({model:(r=e.model)!=null?r:this.model,contents:e.contents,config:e.config})),x="",g="",A,I;try{for(var a=y(v),c,l,u;c=!(l=yield new f(a.next())).done;c=!1){let L=l.value;I=L;let T=ft(L);A=T.usageMetadata;let k=(s=(i=T.content)==null?void 0:i.parts)==null?void 0:s[0];if(k!=null&&k.text)"thought"in k&&k.thought?x+=k.text:g+=k.text,T.partial=!0;else if((x||g)&&(!k||!k.inlineData)){let Ue=[];x&&Ue.push({text:x,thought:!0}),g&&Ue.push(Mn(g)),yield{content:{role:"model",parts:Ue},usageMetadata:T.usageMetadata},x="",g=""}yield T}}catch(l){u=[l]}finally{try{c&&(l=a.return)&&(yield new f(l.call(a)))}finally{if(u)throw u[0]}}if((g||x)&&((p=(d=I==null?void 0:I.candidates)==null?void 0:d[0])==null?void 0:p.finishReason)===er.STOP){let L=[];x&&L.push({text:x,thought:!0}),g&&L.push({text:g}),yield{content:{role:"model",parts:L},usageMetadata:A}}}else{let v=yield new f(this.apiClient.models.generateContent({model:(C=e.model)!=null?C:this.model,contents:e.contents,config:e.config}));yield ft(v)}})}get apiClient(){if(this._apiClient)return this._apiClient;let e=E(E({},this.trackingHeaders),this.headers);return this.vertexai?this._apiClient=new dt({vertexai:this.vertexai,project:this.project,location:this.location,httpOptions:{headers:e}}):this._apiClient=new dt({apiKey:this.apiKey,httpOptions:{headers:e}}),this._apiClient}get apiBackend(){return this._apiBackend||(this._apiBackend=this.apiClient.vertexai?"VERTEX_AI":"GEMINI_API"),this._apiBackend}get liveApiVersion(){return this._liveApiVersion||(this._liveApiVersion=this.apiBackend==="VERTEX_AI"?"v1beta1":"v1alpha"),this._liveApiVersion}get liveApiClient(){return this._liveApiClient||(this._liveApiClient=new dt({apiKey:this.apiKey,httpOptions:{headers:this.trackingHeaders,apiVersion:this.liveApiVersion}})),this._liveApiClient}async connect(e){var o,r,i,s;(o=e.liveConnectConfig)!=null&&o.httpOptions&&(e.liveConnectConfig.httpOptions.headers||(e.liveConnectConfig.httpOptions.headers={}),Object.assign(e.liveConnectConfig.httpOptions.headers,this.trackingHeaders),e.liveConnectConfig.httpOptions.apiVersion=this.liveApiVersion),(r=e.config)!=null&&r.systemInstruction&&(e.liveConnectConfig.systemInstruction={role:"system",parts:[Mn(e.config.systemInstruction)]}),e.liveConnectConfig.tools=(i=e.config)==null?void 0:i.tools;let t=await this.liveApiClient.live.connect({model:(s=e.model)!=null?s:this.model,config:e.liveConnectConfig,callbacks:{onmessage:()=>{}}});return new Pe(t)}preprocessRequest(e){if(this.apiBackend==="GEMINI_API"&&(e.config&&(e.config.labels=void 0),e.contents)){for(let t of e.contents)if(t.parts)for(let o of t.parts)On(o.inlineData),On(o.fileData)}}};ce.supportedModels=[/gemini-.*/,/projects\/.+\/locations\/.+\/endpoints\/.+/,/projects\/.+\/locations\/.+\/publishers\/google\/models\/gemini.+/];function On(n){n&&n.displayName&&(n.displayName=void 0)}var pt=class{constructor(e){this.maxSize=e,this.cache=new Map}get(e){let t=this.cache.get(e);return t&&(this.cache.delete(e),this.cache.set(e,t)),t}set(e,t){if(this.cache.size>=this.maxSize&&!this.cache.has(e)){let o=this.cache.keys().next().value;o!==void 0&&this.cache.delete(o)}this.cache.set(e,t)}},M=class M{static newLlm(e){return new(M.resolve(e))({model:e})}static _register(e,t){M.llmRegistryDict.has(e)&&h.info("Updating LLM class for ".concat(e," from ").concat(M.llmRegistryDict.get(e)," to ").concat(t)),M.llmRegistryDict.set(e,t)}static register(e){for(let t of e.supportedModels)M._register(t,e)}static resolve(e){let t=M.resolveCache.get(e);if(t)return t;for(let[o,r]of M.llmRegistryDict.entries())if(new RegExp("^".concat(o instanceof RegExp?o.source:o,"$"),o instanceof RegExp?o.flags:void 0).test(e))return M.resolveCache.set(e,r),r;throw new Error("Model ".concat(e," not found."))}};M.llmRegistryDict=new Map,M.resolveCache=new pt(32);var le=M;le.register(ce);var mt=Symbol.for("google.adk.baseTool");function tr(n){return typeof n=="object"&&n!==null&&mt in n&&n[mt]===!0}var Nn;Nn=mt;var N=class{constructor(e){this[Nn]=!0;var t;this.name=e.name,this.description=e.description,this.isLongRunning=(t=e.isLongRunning)!=null?t:!1}_getDeclaration(){}async processLlmRequest({llmRequest:e}){let t=this._getDeclaration();if(!t)return;e.toolsDict[this.name]=this;let o=nr(e);o?(o.functionDeclarations||(o.functionDeclarations=[]),o.functionDeclarations.push(t)):(e.config=e.config||{},e.config.tools=e.config.tools||[],e.config.tools.push({functionDeclarations:[t]}))}get apiVariant(){return Bn()}};function nr(n){var e;return(((e=n.config)==null?void 0:e.tools)||[]).find(t=>"functionDeclarations"in t)}import{Type as cr}from"@google/genai";import{Type as Fn}from"@google/genai";import{zodToJsonSchema as or}from"zod-to-json-schema";import{toJSONSchema as rr}from"zod/v4";function gt(n){return n!==null&&typeof n=="object"&&"parse"in n&&typeof n.parse=="function"&&"safeParse"in n&&typeof n.safeParse=="function"}function ir(n){return gt(n)&&!("_zod"in n)}function sr(n){return gt(n)&&"_zod"in n}function ar(n){var o,r;let e=n;if((o=e._def)!=null&&o.typeName)return e._def.typeName;let t=(r=e._def)==null?void 0:r.type;if(typeof t=="string"&&t)return"Zod"+t.charAt(0).toUpperCase()+t.slice(1)}function _e(n){return gt(n)&&ar(n)==="ZodObject"}function ht(n){if(!_e(n))throw new Error("Expected a Zod Object");if(sr(n))return rr(n,{target:"openapi-3.0",io:"input",override:e=>{var o;let{jsonSchema:t}=e;t.additionalProperties!==void 0&&delete t.additionalProperties,t.readOnly!==void 0&&delete t.readOnly,t.maxItems!==void 0&&(t.maxItems=t.maxItems.toString()),(t.format==="email"||t.format==="uuid")&&delete t.pattern,t.minItems!==void 0&&(t.minItems=t.minItems.toString()),t.minLength!==void 0&&(t.minLength=t.minLength.toString()),t.maxLength!==void 0&&(t.maxLength=t.maxLength.toString()),((o=t.enum)==null?void 0:o.length)===1&&t.enum[0]===null&&(t.type=Fn.NULL,delete t.enum),t.type!==void 0&&(t.type=t.type.toUpperCase())}});if(ir(n))return or(n,{target:"openApi3",emailStrategy:"format:email",postProcess:e=>{var t,o,r,i,s,a,c;if(e)return e.additionalProperties!==void 0&&delete e.additionalProperties,e.maxItems!==void 0&&(e.maxItems=(t=e.maxItems)==null?void 0:t.toString()),e.minItems!==void 0&&(e.minItems=(o=e.minItems)==null?void 0:o.toString()),e.minLength!==void 0&&(e.minLength=(r=e.minLength)==null?void 0:r.toString()),e.maxLength!==void 0&&(e.maxLength=(i=e.maxLength)==null?void 0:i.toString()),((s=e.enum)==null?void 0:s.length)===1&&e.enum[0]==="null"&&(e.type=Fn.NULL,delete e.enum),e.type==="integer"&&e.format!=="int64"&&((a=e.minimum)!=null||(e.minimum=Number.MIN_SAFE_INTEGER),(c=e.maximum)!=null||(e.maximum=Number.MAX_SAFE_INTEGER)),e.type!==void 0&&(e.type=e.type.toUpperCase()),e}});throw new Error("Unsupported Zod schema version.")}function lr(n){return n===void 0?{type:cr.OBJECT,properties:{}}:_e(n)?ht(n):n}var Ct=Symbol.for("google.adk.functionTool");function ur(n){return typeof n=="object"&&n!==null&&Ct in n&&n[Ct]===!0}var Dn,Gn,U=class extends(Gn=N,Dn=Ct,Gn){constructor(t){var r;let o=(r=t.name)!=null?r:t.execute.name;if(!o)throw new Error("Tool name cannot be empty. Either name the `execute` function or provide a `name`.");super({name:o,description:t.description,isLongRunning:t.isLongRunning});this[Dn]=!0;this.execute=t.execute,this.parameters=t.parameters}_getDeclaration(){return{name:this.name,description:this.description,parameters:lr(this.parameters)}}async runAsync(t){try{let o=t.args;return _e(this.parameters)&&(o=this.parameters.parse(t.args)),await this.execute(o,t.toolContext)}catch(o){let r=o instanceof Error?o.message:String(o);throw new Error("Error in tool '".concat(this.name,"': ").concat(r))}}};import{cloneDeep as fr}from"lodash-es";function vt(n,e,t){var s,a,c;let o=[];for(let l of n)!((s=l.content)!=null&&s.role)||((c=(a=l.content.parts)==null?void 0:a[0])==null?void 0:c.text)===""||t&&l.branch&&!t.startsWith(l.branch)||dr(l)||pr(l)||o.push(qn(e,l)?mr(l):l);let r=gr(o);r=hr(r);let i=[];for(let l of r){let u=fr(l.content);vn(u),i.push(u)}return i}function Un(n,e,t){for(let o=n.length-1;o>=0;o--){let r=n[o];if(r.author==="user"||qn(e,r))return vt(n.slice(o),e,t)}return[]}function dr(n){var e,t,o;if(!((e=n.content)!=null&&e.parts))return!1;for(let r of n.content.parts)if(((t=r.functionCall)==null?void 0:t.name)===Re||((o=r.functionResponse)==null?void 0:o.name)===Re)return!0;return!1}function pr(n){var e,t,o;if(!((e=n.content)!=null&&e.parts))return!1;for(let r of n.content.parts)if(((t=r.functionCall)==null?void 0:t.name)===se||((o=r.functionResponse)==null?void 0:o.name)===se)return!0;return!1}function qn(n,e){return!!n&&e.author!==n&&e.author!=="user"}function mr(n){var t,o,r,i,s,a;if(!((o=(t=n.content)==null?void 0:t.parts)!=null&&o.length))return n;let e={role:"user",parts:[{text:"For context:"}]};for(let c of n.content.parts)if(c.text&&!c.thought)(r=e.parts)==null||r.push({text:"[".concat(n.author,"] said: ").concat(c.text)});else if(c.functionCall){let l=$n(c.functionCall.args);(i=e.parts)==null||i.push({text:"[".concat(n.author,"] called tool `").concat(c.functionCall.name,"` with parameters: ").concat(l)})}else if(c.functionResponse){let l=$n(c.functionResponse.response);(s=e.parts)==null||s.push({text:"[".concat(n.author,"] tool `").concat(c.functionResponse.name,"` returned result: ").concat(l)})}else(a=e.parts)==null||a.push(c);return S({invocationId:n.invocationId,author:"user",content:e,branch:n.branch,timestamp:n.timestamp})}function zn(n){var r;if(n.length===0)throw new Error("Cannot merge an empty list of events.");let e=S(n[0]),t=((r=e.content)==null?void 0:r.parts)||[];if(t.length===0)throw new Error("There should be at least one function_response part.");let o={};for(let i=0;i<t.length;i++){let s=t[i];s.functionResponse&&s.functionResponse.id&&(o[s.functionResponse.id]=i)}for(let i of n.slice(1)){if(!i.content||!i.content.parts)throw new Error("There should be at least one function_response part.");for(let s of i.content.parts)if(s.functionResponse&&s.functionResponse.id){let a=s.functionResponse.id;a in o?t[o[a]]=s:(t.push(s),o[a]=t.length-1)}else t.push(s)}return e}function gr(n){if(n.length===0)return n;let e=n[n.length-1],t=_(e);if(!(t!=null&&t.length))return n;let o=new Set(t.filter(c=>!!c.id).map(c=>c.id)),r=n.at(-2);if(r){let c=w(r);if(c){for(let l of c)if(l.id&&o.has(l.id))return n}}let i=-1;for(let c=n.length-2;c>=0;c--){let l=n[c],u=w(l);if(u!=null&&u.length){for(let d of u)if(d.id&&o.has(d.id)){i=c;let p=new Set(u.map(v=>v.id).filter(v=>!!v));if(!Array.from(o).every(v=>p.has(v)))throw new Error("Last response event should only contain the responses for the function calls in the same function call event. Function"+" call ids found : ".concat(Array.from(p).join(", "),", function response")+" ids provided: ".concat(Array.from(o).join(", ")));o=p;break}}}if(i===-1)throw new Error("No function call event found for function responses ids: ".concat(Array.from(o).join(", ")));let s=[];for(let c=i+1;c<n.length-1;c++){let l=n[c],u=_(l);u&&u.some(d=>d.id&&o.has(d.id))&&s.push(l)}s.push(n[n.length-1]);let a=n.slice(0,i+1);return a.push(zn(s)),a}function hr(n){let e=new Map;for(let o=0;o<n.length;o++){let r=n[o],i=_(r);if(i!=null&&i.length)for(let s of i)s.id&&e.set(s.id,o)}let t=[];for(let o of n){if(_(o).length>0)continue;let r=w(o);if(r!=null&&r.length){let i=new Set;for(let s of r){let a=s.id;a&&e.has(a)&&i.add(e.get(a))}if(t.push(o),i.size===0)continue;if(i.size===1){let[s]=[...i];t.push(n[s])}else{let a=Array.from(i).sort((c,l)=>c-l).map(c=>n[c]);t.push(zn(a))}}else t.push(o)}return t}function $n(n){if(typeof n=="string")return n;try{return JSON.stringify(n)}catch(e){return String(n)}}async function At(n,e){let t=e.invocationContext;async function o(c){let l=c[0].replace(/^\{+/,"").replace(/\}+$/,"").trim(),u=l.endsWith("?");if(u&&(l=l.slice(0,-1)),l.startsWith("artifact.")){let d=l.substring(9);if(t.artifactService===void 0)throw new Error("Artifact service is not initialized.");let p=await t.artifactService.loadArtifact({appName:t.session.appName,userId:t.session.userId,sessionId:t.session.id,filename:d});if(!p)throw new Error("Artifact ".concat(d," not found."));return String(p)}if(!Ar(l))return c[0];if(l in t.session.state)return String(t.session.state[l]);if(u)return"";throw new Error("Context variable not found: `".concat(l,"`."))}let r=/\{+[^{}]*}+/g,i=[],s=0,a=n.matchAll(r);for(let c of a){i.push(n.slice(s,c.index));let l=await o(c);i.push(l),s=c.index+c[0].length}return i.push(n.slice(s)),i.join("")}var Cr=/^[a-zA-Z_][a-zA-Z0-9_]*$/;function jn(n){return n===""||n===void 0?!1:Cr.test(n)}var vr=[b.APP_PREFIX,b.USER_PREFIX,b.TEMP_PREFIX];function Ar(n){let e=n.split(":");return e.length===0||e.length>2?!1:e.length===1?jn(n):vr.includes(e[0]+":")?jn(e[1]):!1}var xt=(o=>(o.NONE="none",o.SSE="sse",o.BIDI="bidi",o))(xt||{});function Vn(n={}){return E({saveInputBlobsAsArtifacts:!1,supportCfc:!1,enableAffectiveDialog:!1,streamingMode:"none",maxLlmCalls:xr(n.maxLlmCalls||500)},n)}function xr(n){if(n>Number.MAX_SAFE_INTEGER)throw new Error("maxLlmCalls should be less than ".concat(Number.MAX_SAFE_INTEGER,"."));return n<=0&&h.warn("maxLlmCalls is less than or equal to 0. This will result in no enforcement on total number of llm calls that will be made for a run. This may not be ideal, as this could result in a never ending communication between the model and the agent in certain cases."),n}var Jn="adk_agent_name";async function Wn(n,e){return n instanceof N?[n]:await n.getTools(e)}var yt=class extends G{runAsync(e,t){return m(this,null,function*(){var r;let o=e.agent;R(o)&&(t.model=o.canonicalModel.model,t.config=E({},(r=o.generateContentConfig)!=null?r:{}),o.outputSchema&&_n(t,o.outputSchema),e.runConfig&&(t.liveConnectConfig.responseModalities=e.runConfig.responseModalities,t.liveConnectConfig.speechConfig=e.runConfig.speechConfig,t.liveConnectConfig.outputAudioTranscription=e.runConfig.outputAudioTranscription,t.liveConnectConfig.inputAudioTranscription=e.runConfig.inputAudioTranscription,t.liveConnectConfig.realtimeInputConfig=e.runConfig.realtimeInputConfig,t.liveConnectConfig.enableAffectiveDialog=e.runConfig.enableAffectiveDialog,t.liveConnectConfig.proactivity=e.runConfig.proactivity))})}},br=new yt,Et=class extends G{runAsync(e,t){return m(this,null,function*(){let o=e.agent,r=['You are an agent. Your internal name is "'.concat(o.name,'".')];o.description&&r.push('The description about you is "'.concat(o.description,'"')),xe(t,r)})}},Tr=new Et,bt=class extends G{runAsync(e,t){return m(this,null,function*(){let o=e.agent;if(!(o instanceof Y)||!(o.rootAgent instanceof Y))return;let r=o.rootAgent;if(R(r)&&r.globalInstruction){let{instruction:i,requireStateInjection:s}=yield new f(r.canonicalGlobalInstruction(new P(e))),a=i;s&&(a=yield new f(At(i,new P(e)))),xe(t,[a])}if(o.instruction){let{instruction:i,requireStateInjection:s}=yield new f(o.canonicalInstruction(new P(e))),a=i;s&&(a=yield new f(At(i,new P(e)))),xe(t,[a])}})}},Sr=new bt,Tt=class{runAsync(e,t){return m(this,null,function*(){let o=e.agent;!o||!R(o)||(o.includeContents==="default"?t.contents=vt(e.session.events,o.name,e.branch):t.contents=Un(e.session.events,o.name,e.branch))})}},Ir=new Tt,St=class extends G{constructor(){super(...arguments);this.toolName="transfer_to_agent";this.tool=new U({name:this.toolName,description:"Transfer the question to another agent. This tool hands off control to another agent when it is more suitable to answer the user question according to the agent description.",parameters:Zn.object({agentName:Zn.string().describe("the agent name to transfer to.")}),execute:function(t,o){if(!o)throw new Error("toolContext is required.");return o.actions.transferToAgent=t.agentName,"Transfer queued"}})}runAsync(t,o){return m(this,null,function*(){if(!(t.agent instanceof Y))return;let r=this.getTransferTargets(t.agent);if(!r.length)return;xe(o,[this.buildTargetAgentsInstructions(t.agent,r)]);let i=new q({invocationContext:t});yield new f(this.tool.processLlmRequest({toolContext:i,llmRequest:o}))})}buildTargetAgentsInfo(t){return"\nAgent name: ".concat(t.name,"\nAgent description: ").concat(t.description,"\n")}buildTargetAgentsInstructions(t,o){let r="\nYou have a list of other agents to transfer to:\n\n".concat(o.map(this.buildTargetAgentsInfo).join("\n"),"\n\nIf you are the best to answer the question according to your description, you\ncan answer it.\n\nIf another agent is better for answering the question according to its\ndescription, call `").concat(this.toolName,"` function to transfer the\nquestion to that agent. When transferring, do not generate any text other than\nthe function call.\n");return t.parentAgent&&!t.disallowTransferToParent&&(r+="\nYour parent agent is ".concat(t.parentAgent.name,". If neither the other agents nor\nyou are best for answering the question according to the descriptions, transfer\nto your parent agent.\n")),r}getTransferTargets(t){let o=[];return o.push(...t.subAgents),!t.parentAgent||!R(t.parentAgent)||(t.disallowTransferToParent||o.push(t.parentAgent),t.disallowTransferToPeers||o.push(...t.parentAgent.subAgents.filter(r=>r.name!==t.name))),o}},Rr=new St,It=class extends G{runAsync(e){return m(this,null,function*(){let t=e.agent;if(!R(t))return;let o=e.session.events;if(!o||o.length===0)return;let r={},i=-1;for(let s=o.length-1;s>=0;s--){let a=o[s];if(a.author!=="user")continue;let c=_(a);if(!c)continue;let l=!1;for(let u of c){if(u.name!==se)continue;l=!0;let d=null;u.response&&Object.keys(u.response).length===1&&"response"in u.response?d=JSON.parse(u.response.response):u.response&&(d=new V({hint:u.response.hint,payload:u.response.payload,confirmed:u.response.confirmed})),u.id&&d&&(r[u.id]=d)}if(l){i=s;break}}if(Object.keys(r).length!==0)for(let s=i-1;s>=0;s--){let a=o[s],c=w(a);if(!c)continue;let l={},u={};for(let v of c){if(!v.id||!(v.id in r))continue;let x=v.args;if(!x||!("originalFunctionCall"in x))continue;let g=x.originalFunctionCall;g.id&&(l[g.id]=r[v.id],u[g.id]=g)}if(Object.keys(l).length===0)continue;for(let v=o.length-1;v>i;v--){let x=o[v],g=_(x);if(g){for(let A of g)A.id&&A.id in l&&(delete l[A.id],delete u[A.id]);if(Object.keys(l).length===0)break}}if(Object.keys(l).length===0)continue;let d=yield new f(t.canonicalTools(new P(e))),p=Object.fromEntries(d.map(v=>[v.name,v])),C=yield new f(we({invocationContext:e,functionCalls:Object.values(u),toolsDict:p,beforeToolCallbacks:t.canonicalBeforeToolCallbacks,afterToolCallbacks:t.canonicalAfterToolCallbacks,filters:new Set(Object.keys(l)),toolConfirmationDict:l}));C&&(yield C);return}})}},wr=new It,Rt=class extends G{runAsync(e,t){return m(this,null,function*(){if(e.agent instanceof Y&&e.agent.codeExecutor){try{for(var o=y(Lr(e,t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let a=i.value;yield a}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}if(ke(e.agent.codeExecutor))for(let a of t.contents){let c=e.agent.codeExecutor.codeBlockDelimiters.length?e.agent.codeExecutor.codeBlockDelimiters[0]:["",""];kn(a,c,e.agent.codeExecutor.executionResultDelimiters)}}})}},Be={"text/csv":{extension:".csv",loaderCodeTemplate:"pd.read_csv('{filename}')"}},kr="\nimport pandas as pd\n\ndef explore_df(df: pd.DataFrame) -> None:\n  \"\"\"Prints some information about a pandas DataFrame.\"\"\"\n\n  with pd.option_context(\n      'display.max_columns', None, 'display.expand_frame_repr', False\n  ):\n    # Print the column names to never encounter KeyError when selecting one.\n    df_dtypes = df.dtypes\n\n    # Obtain information about data types and missing values.\n    df_nulls = (len(df) - df.isnull().sum()).apply(\n        lambda x: f'{x} / {df.shape[0]} non-null'\n    )\n\n    # Explore unique total values in columns using `.unique()`.\n    df_unique_count = df.apply(lambda x: len(x.unique()))\n\n    # Explore unique values in columns using `.unique()`.\n    df_unique = df.apply(lambda x: crop(str(list(x.unique()))))\n\n    df_info = pd.concat(\n        (\n            df_dtypes.rename('Dtype'),\n            df_nulls.rename('Non-Null Count'),\n            df_unique_count.rename('Unique Values Count'),\n            df_unique.rename('Unique Values'),\n        ),\n        axis=1,\n    )\n    df_info.index.name = 'Columns'\n    print(f\"\"\"Total rows: {df.shape[0]}\nTotal columns: {df.shape[1]}\n\n{df_info}\"\"\")\n",wt=class{runAsync(e,t){return m(this,null,function*(){if(!t.partial)try{for(var o=y(Pr(e,t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let a=i.value;yield a}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}})}},nc=new wt;function Lr(n,e){return m(this,null,function*(){let t=n.agent;if(!R(t))return;let o=t.codeExecutor;if(!o||!ke(o))return;if(ve(o)){o.processLlmRequest(e);return}if(!o.optimizeDataFile)return;let r=new Ae(new b(n.session.state));if(r.getErrorCount(n.invocationId)>=o.errorRetryAttempts)return;let i=_r(r,e),s=new Set(r.getProcessedFileNames()),a=i.filter(c=>!s.has(c.name));for(let c of a){let l=Br(c);if(!l)return;let u={role:"model",parts:[{text:"Processing input file: `".concat(c.name,"`")},it(l)]};e.contents.push(Kn(u)),yield S({invocationId:n.invocationId,author:t.name,branch:n.branch,content:u});let d=Xn(n,r),p=yield new f(o.executeCode({invocationContext:n,codeExecutionInput:{code:l,inputFiles:[c],executionId:d}}));r.updateCodeExecutionResult({invocationId:n.invocationId,code:l,resultStdout:p.stdout,resultStderr:p.stderr}),r.addProcessedFileNames([c.name]);let C=yield new f(Hn(n,r,p));yield C,e.contents.push(Kn(C.content))}})}function Pr(n,e){return m(this,null,function*(){let t=n.agent;if(!R(t))return;let o=t.codeExecutor;if(!o||!ke(o)||!e||!e.content||ve(o))return;let r=new Ae(new b(n.session.state));if(r.getErrorCount(n.invocationId)>=o.errorRetryAttempts)return;let i=e.content,s=Rn(i,o.codeBlockDelimiters);if(!s)return;yield S({invocationId:n.invocationId,author:t.name,branch:n.branch,content:i});let a=Xn(n,r),c=yield new f(o.executeCode({invocationContext:n,codeExecutionInput:{code:s,inputFiles:r.getInputFiles(),executionId:a}}));r.updateCodeExecutionResult({invocationId:n.invocationId,code:s,resultStdout:c.stdout,resultStderr:c.stderr}),yield yield new f(Hn(n,r,c)),e.content=void 0})}function _r(n,e){var r;let t=n.getInputFiles(),o=new Set(t.map(i=>i.name));for(let i=0;i<e.contents.length;i++){let s=e.contents[i];if(!(s.role!=="user"||!s.parts))for(let a=0;a<s.parts.length;a++){let c=s.parts[a],l=(r=c.inlineData)==null?void 0:r.mimeType;if(!l||!c.inlineData||!Be[l])continue;let u="data_".concat(i+1,"_").concat(a+1).concat(Be[l].extension);c.text="\nAvailable file: `".concat(u,"`\n");let d={name:u,content:ln(c.inlineData.data),mimeType:l};o.has(u)||(n.addInputFiles([d]),t.push(d))}}return t}function Xn(n,e){var r;let t=n.agent;if(!R(t)||!((r=t.codeExecutor)!=null&&r.stateful))return;let o=e.getExecutionId();return o||(o=n.session.id,e.setExecutionId(o)),o}async function Hn(n,e,t){if(!n.artifactService)throw new Error("Artifact service is not initialized.");let o={role:"model",parts:[wn(t)]},r=F({stateDelta:e.getStateDelta()});t.stderr?e.incrementErrorCount(n.invocationId):e.resetErrorCount(n.invocationId);for(let i of t.outputFiles){let s=await n.artifactService.saveArtifact({appName:n.appName||"",userId:n.userId||"",sessionId:n.session.id,filename:i.name,artifact:{inlineData:{data:i.content,mimeType:i.mimeType}}});r.artifactDelta[i.name]=s}return S({invocationId:n.invocationId,author:n.agent.name,branch:n.branch,content:o,actions:r})}function Br(n){function e(r){let[i]=r.split("."),s=i.replace(/[^a-zA-Z0-9_]/g,"_");return/^\d/.test(s)&&(s="_"+s),s}if(!Be[n.mimeType])return;let t=e(n.name),o=Be[n.mimeType].loaderCodeTemplate.replace("{filename}",n.name);return"\n".concat(kr,"\n\n# Load the dataframe.\n").concat(t," = ").concat(o,"\n\n# Use `explore_df` to guide my analysis.\nexplore_df(").concat(t,")\n")}var Mr=new Rt,kt=Symbol.for("google.adk.llmAgent");function R(n){return typeof n=="object"&&n!==null&&kt in n&&n[kt]===!0}var Yn,Qn,Y=class n extends(Qn=O,Yn=kt,Qn){constructor(t){var r,i,s,a,c,l,u,d,p;super(t);this[Yn]=!0;if(this.model=t.model,this.instruction=(r=t.instruction)!=null?r:"",this.globalInstruction=(i=t.globalInstruction)!=null?i:"",this.tools=(s=t.tools)!=null?s:[],this.generateContentConfig=t.generateContentConfig,this.disallowTransferToParent=(a=t.disallowTransferToParent)!=null?a:!1,this.disallowTransferToPeers=(c=t.disallowTransferToPeers)!=null?c:!1,this.includeContents=(l=t.includeContents)!=null?l:"default",this.inputSchema=t.inputSchema,this.outputSchema=t.outputSchema,this.outputKey=t.outputKey,this.beforeModelCallback=t.beforeModelCallback,this.afterModelCallback=t.afterModelCallback,this.beforeToolCallback=t.beforeToolCallback,this.afterToolCallback=t.afterToolCallback,this.codeExecutor=t.codeExecutor,this.requestProcessors=(u=t.requestProcessors)!=null?u:[br,Tr,Sr,wr,Ir,Mr],this.responseProcessors=(d=t.responseProcessors)!=null?d:[],this.disallowTransferToParent&&this.disallowTransferToPeers&&!((p=this.subAgents)!=null&&p.length)||this.requestProcessors.push(Rr),t.generateContentConfig){if(t.generateContentConfig.tools)throw new Error("All tools must be set via LlmAgent.tools.");if(t.generateContentConfig.systemInstruction)throw new Error("System instruction must be set via LlmAgent.instruction.");if(t.generateContentConfig.responseSchema)throw new Error("Response schema must be set via LlmAgent.output_schema.")}else this.generateContentConfig={};if(this.outputSchema){if((!this.disallowTransferToParent||!this.disallowTransferToPeers)&&(h.warn("Invalid config for agent ".concat(this.name,": outputSchema cannot co-exist with agent transfer configurations. Setting disallowTransferToParent=true, disallowTransferToPeers=true")),this.disallowTransferToParent=!0,this.disallowTransferToPeers=!0),this.subAgents&&this.subAgents.length>0)throw new Error("Invalid config for agent ".concat(this.name,": if outputSchema is set, subAgents must be empty to disable agent transfer."));if(this.tools&&this.tools.length>0)throw new Error("Invalid config for agent ".concat(this.name,": if outputSchema is set, tools must be empty"))}}get canonicalModel(){if(ut(this.model))return this.model;if(typeof this.model=="string"&&this.model)return le.newLlm(this.model);let t=this.parentAgent;for(;t;){if(R(t))return t.canonicalModel;t=t.parentAgent}throw new Error("No model found for ".concat(this.name,"."))}async canonicalInstruction(t){return typeof this.instruction=="string"?{instruction:this.instruction,requireStateInjection:!0}:{instruction:await this.instruction(t),requireStateInjection:!1}}async canonicalGlobalInstruction(t){return typeof this.globalInstruction=="string"?{instruction:this.globalInstruction,requireStateInjection:!0}:{instruction:await this.globalInstruction(t),requireStateInjection:!1}}async canonicalTools(t){let o=[];for(let r of this.tools){let i=await Wn(r,t);o.push(...i)}return o}static normalizeCallbackArray(t){return t?Array.isArray(t)?t:[t]:[]}get canonicalBeforeModelCallbacks(){return n.normalizeCallbackArray(this.beforeModelCallback)}get canonicalAfterModelCallbacks(){return n.normalizeCallbackArray(this.afterModelCallback)}get canonicalBeforeToolCallbacks(){return n.normalizeCallbackArray(this.beforeToolCallback)}get canonicalAfterToolCallbacks(){return n.normalizeCallbackArray(this.afterToolCallback)}maybeSaveOutputToState(t){var i,s;if(t.author!==this.name){h.debug("Skipping output save for agent ".concat(this.name,": event authored by ").concat(t.author));return}if(!this.outputKey){h.debug("Skipping output save for agent ".concat(this.name,": outputKey is not set"));return}if(!oe(t)){h.debug("Skipping output save for agent ".concat(this.name,": event is not a final response"));return}if(!((s=(i=t.content)==null?void 0:i.parts)!=null&&s.length)){h.debug("Skipping output save for agent ".concat(this.name,": event content is empty"));return}let o=t.content.parts.map(a=>a.text?a.text:"").join(""),r=o;if(this.outputSchema){if(!o.trim())return;try{r=JSON.parse(o)}catch(a){h.error("Error parsing output for agent ".concat(this.name),a)}}t.actions.stateDelta[this.outputKey]=r}runAsyncImpl(t){return m(this,null,function*(){for(;;){let a;try{for(var o=y(this.runOneStepAsync(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let c=i.value;a=c,this.maybeSaveOutputToState(c),yield c}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}if(!a||oe(a))break;if(a.partial){h.warn("The last event is partial, which is not expected.");break}}})}runLiveImpl(t){return m(this,null,function*(){try{for(var o=y(this.runLiveFlow(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let a=i.value;this.maybeSaveOutputToState(a),yield a}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}t.endInvocation})}runLiveFlow(t){return m(this,null,function*(){throw yield new f(Promise.resolve()),new Error("LlmAgent.runLiveFlow not implemented")})}runOneStepAsync(t){return m(this,null,function*(){let o={contents:[],toolsDict:{},liveConnectConfig:{}};for(let d of this.requestProcessors)try{for(var a=y(d.runAsync(t,o)),c,l,u;c=!(l=yield new f(a.next())).done;c=!1){let p=l.value;yield p}}catch(l){u=[l]}finally{try{c&&(l=a.return)&&(yield new f(l.call(a)))}finally{if(u)throw u[0]}}for(let d of this.tools){let p=new q({invocationContext:t}),C=yield new f(Wn(d,new P(t)));for(let v of C)yield new f(v.processLlmRequest({toolContext:p,llmRequest:o}))}if(t.endInvocation)return;let r=S({invocationId:t.invocationId,author:this.name,branch:t.branch}),i=D.startSpan("call_llm"),s=Er.setSpan(yr.active(),i);yield*z(j(s,this,function(){return m(this,null,function*(){try{for(var x=y(this.callLlmAsync(t,o,r)),g,A,I;g=!(A=yield new f(x.next())).done;g=!1){let L=A.value;try{for(var d=y(this.postprocess(t,o,L,r)),p,C,v;p=!(C=yield new f(d.next())).done;p=!1){let T=C.value;r.id=ze(),r.timestamp=new Date().getTime(),yield T}}catch(C){v=[C]}finally{try{p&&(C=d.return)&&(yield new f(C.call(d)))}finally{if(v)throw v[0]}}}}catch(A){I=[A]}finally{try{g&&(A=x.return)&&(yield new f(A.call(x)))}finally{if(I)throw I[0]}}})})),i.end()})}postprocess(t,o,r,i){return m(this,null,function*(){var x;for(let T of this.responseProcessors)try{for(var d=y(T.runAsync(t,r)),p,C,v;p=!(C=yield new f(d.next())).done;p=!1){let k=C.value;yield k}}catch(C){v=[C]}finally{try{p&&(C=d.return)&&(yield new f(C.call(d)))}finally{if(v)throw v[0]}}if(!r.content&&!r.errorCode&&!r.interrupted)return;let s=S(E(E({},i),r));if(s.content){let T=w(s);T!=null&&T.length&&(Cn(s),s.longRunningToolIds=Array.from(An(T,o.toolsDict)))}if(yield s,!((x=w(s))!=null&&x.length))return;let a=yield new f(xn({invocationContext:t,functionCallEvent:s,toolsDict:o.toolsDict,beforeToolCallbacks:this.canonicalBeforeToolCallbacks,afterToolCallbacks:this.canonicalAfterToolCallbacks}));if(!a)return;let c=He(t,a);c&&(yield c);let l=et({invocationContext:t,functionCallEvent:s,functionResponseEvent:a});l&&(yield l),yield a;let u=a.actions.transferToAgent;if(u){let T=this.getAgentByName(t,u);try{for(var g=y(T.runAsync(t)),A,I,L;A=!(I=yield new f(g.next())).done;A=!1){let k=I.value;yield k}}catch(I){L=[I]}finally{try{A&&(I=g.return)&&(yield new f(I.call(g)))}finally{if(L)throw L[0]}}}})}getAgentByName(t,o){let i=t.agent.rootAgent.findAgent(o);if(!i)throw new Error("Agent ".concat(o," not found in the agent tree."));return i}callLlmAsync(t,o,r){return m(this,null,function*(){var a,c,l,u,d;let i=yield new f(this.handleBeforeModelCallback(t,o,r));if(i){yield i;return}(a=o.config)!=null||(o.config={}),(l=(c=o.config).labels)!=null||(c.labels={}),o.config.labels[Jn]||(o.config.labels[Jn]=this.name);let s=this.canonicalModel;if((u=t.runConfig)!=null&&u.supportCfc)throw new Error("CFC is not yet supported in callLlmAsync");{t.incrementLlmCallCount();let g=s.generateContentAsync(o,((d=t.runConfig)==null?void 0:d.streamingMode)==="sse");try{for(var p=y(this.runAndHandleError(g,t,o,r)),C,v,x;C=!(v=yield new f(p.next())).done;C=!1){let A=v.value;an({invocationContext:t,eventId:r.id,llmRequest:o,llmResponse:A});let I=yield new f(this.handleAfterModelCallback(t,A,r));yield I!=null?I:A}}catch(v){x=[v]}finally{try{C&&(v=p.return)&&(yield new f(v.call(p)))}finally{if(x)throw x[0]}}}})}async handleBeforeModelCallback(t,o,r){let i=new B({invocationContext:t,eventActions:r.actions}),s=await t.pluginManager.runBeforeModelCallback({callbackContext:i,llmRequest:o});if(s)return s;for(let a of this.canonicalBeforeModelCallbacks){let c=await a({context:i,request:o});if(c)return c}}async handleAfterModelCallback(t,o,r){let i=new B({invocationContext:t,eventActions:r.actions}),s=await t.pluginManager.runAfterModelCallback({callbackContext:i,llmResponse:o});if(s)return s;for(let a of this.canonicalAfterModelCallbacks){let c=await a({context:i,response:o});if(c)return c}}runAndHandleError(t,o,r,i){return m(this,null,function*(){try{try{for(var s=y(t),a,c,l;a=!(c=yield new f(s.next())).done;a=!1){let u=c.value;yield u}}catch(c){l=[c]}finally{try{a&&(c=s.return)&&(yield new f(c.call(s)))}finally{if(l)throw l[0]}}}catch(u){let d=new B({invocationContext:o,eventActions:i.actions});if(u instanceof Error){let p=yield new f(o.pluginManager.runOnModelErrorCallback({callbackContext:d,llmRequest:r,error:u}));if(p)yield p;else{let C=JSON.parse(u.message);yield{errorCode:String(C.error.code),errorMessage:C.error.message}}}else throw h.error("Unknown error during response generation",u),u}})}};var Lt=Symbol.for("google.adk.loopAgent");function Or(n){return typeof n=="object"&&n!==null&&Lt in n&&n[Lt]===!0}var eo,to,Pt=class extends(to=O,eo=Lt,to){constructor(t){var o;super(t);this[eo]=!0;this.maxIterations=(o=t.maxIterations)!=null?o:Number.MAX_SAFE_INTEGER}runAsyncImpl(t){return m(this,null,function*(){let o=0;for(;o<this.maxIterations;){for(let c of this.subAgents){let l=!1;try{for(var r=y(c.runAsync(t)),i,s,a;i=!(s=yield new f(r.next())).done;i=!1){let u=s.value;yield u,u.actions.escalate&&(l=!0)}}catch(s){a=[s]}finally{try{i&&(s=r.return)&&(yield new f(s.call(r)))}finally{if(a)throw a[0]}}if(l)return}o++}})}runLiveImpl(t){return m(this,null,function*(){throw new Error("This is not supported yet for LoopAgent.")})}};var _t=Symbol.for("google.adk.parallelAgent");function Nr(n){return typeof n=="object"&&n!==null&&_t in n&&n[_t]===!0}var no,oo,Bt=class extends(oo=O,no=_t,oo){constructor(){super(...arguments);this[no]=!0}runAsyncImpl(t){return m(this,null,function*(){let o=this.subAgents.map(c=>c.runAsync(Fr(this,c,t)));try{for(var r=y(Dr(o)),i,s,a;i=!(s=yield new f(r.next())).done;i=!1){let c=s.value;yield c}}catch(s){a=[s]}finally{try{i&&(s=r.return)&&(yield new f(s.call(r)))}finally{if(a)throw a[0]}}})}runLiveImpl(t){return m(this,null,function*(){throw new Error("This is not supported yet for ParallelAgent.")})}};function Fr(n,e,t){let o=new $(t),r="".concat(n.name,".").concat(e.name);return o.branch=o.branch?"".concat(o.branch,".").concat(r):r,o}function Dr(n){return m(this,null,function*(){let e=new Map;for(let[t,o]of n.entries()){let r=o.next().then(i=>({result:i,index:t}));e.set(t,r)}for(;e.size>0;){let{result:t,index:o}=yield new f(Promise.race(e.values()));if(t.done){e.delete(o);continue}yield t.value;let r=n[o].next().then(i=>({result:i,index:o}));e.set(o,r)}})}var Mt="task_completed",Ot=Symbol.for("google.adk.sequentialAgent");function Gr(n){return typeof n=="object"&&n!==null&&Ot in n&&n[Ot]===!0}var ro,io,Nt=class extends(io=O,ro=Ot,io){constructor(){super(...arguments);this[ro]=!0}runAsyncImpl(t){return m(this,null,function*(){for(let a of this.subAgents)try{for(var o=y(a.runAsync(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let c=i.value;yield c}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}})}runLiveImpl(t){return m(this,null,function*(){for(let a of this.subAgents)R(a)&&((yield new f(a.canonicalTools(new P(t)))).some(u=>u.name===Mt)||(a.tools.push(new U({name:Mt,description:"Signals that the model has successfully completed the user's question or task.",execute:()=>"Task completion signaled."})),a.instruction+="If you finished the user's request according to its description, call the ".concat(Mt," function to exit so the next agents can take over. When calling this function, do not generate any text other than the function call.")));for(let a of this.subAgents)try{for(var o=y(a.runLive(t)),r,i,s;r=!(i=yield new f(o.next())).done;r=!1){let c=i.value;yield c}}catch(i){s=[i]}finally{try{r&&(i=o.return)&&(yield new f(i.call(o)))}finally{if(s)throw s[0]}}})}};var ye=class{constructor(){this.artifacts={}}saveArtifact({appName:e,userId:t,sessionId:o,filename:r,artifact:i}){let s=Me(e,t,o,r);this.artifacts[s]||(this.artifacts[s]=[]);let a=this.artifacts[s].length;return this.artifacts[s].push(i),Promise.resolve(a)}loadArtifact({appName:e,userId:t,sessionId:o,filename:r,version:i}){let s=Me(e,t,o,r),a=this.artifacts[s];return a?(i===void 0&&(i=a.length-1),Promise.resolve(a[i])):Promise.resolve(void 0)}listArtifactKeys({appName:e,userId:t,sessionId:o}){let r="".concat(e,"/").concat(t,"/").concat(o,"/"),i="".concat(e,"/").concat(t,"/user/"),s=[];for(let a in this.artifacts)if(a.startsWith(r)){let c=a.replace(r,"");s.push(c)}else if(a.startsWith(i)){let c=a.replace(i,"");s.push(c)}return Promise.resolve(s.sort())}deleteArtifact({appName:e,userId:t,sessionId:o,filename:r}){let i=Me(e,t,o,r);return this.artifacts[i]&&delete this.artifacts[i],Promise.resolve()}listVersions({appName:e,userId:t,sessionId:o,filename:r}){let i=Me(e,t,o,r),s=this.artifacts[i];if(!s)return Promise.resolve([]);let a=[];for(let c=0;c<s.length;c++)a.push(c);return Promise.resolve(a)}};function Me(n,e,t,o){return $r(o)?"".concat(n,"/").concat(e,"/user/").concat(o):"".concat(n,"/").concat(e,"/").concat(t,"/").concat(o)}function $r(n){return n.startsWith("user:")}var so=(i=>(i.API_KEY="apiKey",i.HTTP="http",i.OAUTH2="oauth2",i.OPEN_ID_CONNECT="openIdConnect",i.SERVICE_ACCOUNT="serviceAccount",i))(so||{});var Ft=Symbol.for("google.adk.baseExampleProvider");function Ur(n){return typeof n=="object"&&n!==null&&Ft in n&&n[Ft]===!0}var ao;ao=Ft;var Dt=class{constructor(){this[ao]=!0}};var Q=class{constructor(){this.memories=[];this.sessionEvents={}}async addSessionToMemory(e){let t=co(e.appName,e.userId);this.sessionEvents[t]||(this.sessionEvents[t]={}),this.sessionEvents[t][e.id]=e.events.filter(o=>{var r,i,s;return((s=(i=(r=o.content)==null?void 0:r.parts)==null?void 0:i.length)!=null?s:0)>0})}async searchMemory(e){var i,s;let t=co(e.appName,e.userId);if(!this.sessionEvents[t])return Promise.resolve({memories:[]});let o=e.query.toLowerCase().split(/\s+/),r={memories:[]};for(let a of Object.values(this.sessionEvents[t]))for(let c of a){if(!((s=(i=c.content)==null?void 0:i.parts)!=null&&s.length))continue;let l=c.content.parts.map(p=>p.text).filter(p=>!!p).join(" "),u=qr(l);if(!u.size)continue;o.some(p=>u.has(p))&&r.memories.push({content:c.content,author:c.author,timestamp:zr(c.timestamp)})}return r}};function co(n,e){return"".concat(n,"/").concat(e)}function qr(n){return new Set([...n.matchAll(/[A-Za-z]+/)].map(e=>e[0].toLowerCase()))}function zr(n){return new Date(n).toISOString()}var X=class{constructor(e){this.name=e}async onUserMessageCallback(e){}async beforeRunCallback(e){}async onEventCallback(e){}async afterRunCallback(e){}async beforeAgentCallback(e){}async afterAgentCallback(e){}async beforeModelCallback(e){}async afterModelCallback(e){}async onModelErrorCallback(e){}async beforeToolCallback(e){}async afterToolCallback(e){}async onToolErrorCallback(e){}};var Gt=class extends X{constructor(e="logging_plugin"){super(e)}async onUserMessageCallback({invocationContext:e,userMessage:t}){var o;this.log("\u{1F680} USER MESSAGE RECEIVED"),this.log("   Invocation ID: ".concat(e.invocationId)),this.log("   Session ID: ".concat(e.session.id)),this.log("   User ID: ".concat(e.userId)),this.log("   App Name: ".concat(e.appName)),this.log("   Root Agent: ".concat((o=e.agent.name)!=null?o:"Unknown")),this.log("   User Content: ".concat(this.formatContent(t))),e.branch&&this.log("   Branch: ".concat(e.branch))}async beforeRunCallback({invocationContext:e}){var t;this.log("\u{1F3C3} INVOCATION STARTING"),this.log("   Invocation ID: ".concat(e.invocationId)),this.log("   Starting Agent: ".concat((t=e.agent.name)!=null?t:"Unknown"))}async onEventCallback({event:e}){this.log("\u{1F4E2} EVENT YIELDED"),this.log("   Event ID: ".concat(e.id)),this.log("   Author: ".concat(e.author)),this.log("   Content: ".concat(this.formatContent(e.content))),this.log("   Final Response: ".concat(oe(e)));let t=w(e);if(t.length>0){let r=t.map(i=>i.name);this.log("   Function Calls: ".concat(r))}let o=_(e);if(o.length>0){let r=o.map(i=>i.name);this.log("   Function Responses: ".concat(r))}e.longRunningToolIds&&e.longRunningToolIds.length>0&&this.log("   Long Running Tools: ".concat([...e.longRunningToolIds]))}async afterRunCallback({invocationContext:e}){var t;this.log("\u2705 INVOCATION COMPLETED"),this.log("   Invocation ID: ".concat(e.invocationId)),this.log("   Final Agent: ".concat((t=e.agent.name)!=null?t:"Unknown"))}async beforeAgentCallback({callbackContext:e}){this.log("\u{1F916} AGENT STARTING"),this.log("   Agent Name: ".concat(e.agentName)),this.log("   Invocation ID: ".concat(e.invocationId)),e.invocationContext.branch&&this.log("   Branch: ".concat(e.invocationContext.branch))}async afterAgentCallback({callbackContext:e}){this.log("\u{1F916} AGENT COMPLETED"),this.log("   Agent Name: ".concat(e.agentName)),this.log("   Invocation ID: ".concat(e.invocationId))}async beforeModelCallback({callbackContext:e,llmRequest:t}){var o;if(this.log("\u{1F9E0} LLM REQUEST"),this.log("   Model: ".concat((o=t.model)!=null?o:"default")),this.log("   Agent: ".concat(e.agentName)),t.config&&t.config.systemInstruction){let r=t.config.systemInstruction;r.length>200&&(r=r.substring(0,200)+"..."),this.log("   System Instruction: '".concat(r,"'"))}if(t.toolsDict){let r=Object.keys(t.toolsDict);this.log("   Available Tools: ".concat(r))}}async afterModelCallback({callbackContext:e,llmResponse:t}){this.log("\u{1F9E0} LLM RESPONSE"),this.log("   Agent: ".concat(e.agentName)),t.errorCode?(this.log("   \u274C ERROR - Code: ".concat(t.errorCode)),this.log("   Error Message: ".concat(t.errorMessage))):(this.log("   Content: ".concat(this.formatContent(t.content))),t.partial&&this.log("   Partial: ".concat(t.partial)),t.turnComplete!==void 0&&this.log("   Turn Complete: ".concat(t.turnComplete))),t.usageMetadata&&this.log("   Token Usage - Input: ".concat(t.usageMetadata.promptTokenCount,", Output: ").concat(t.usageMetadata.candidatesTokenCount))}async beforeToolCallback({tool:e,toolArgs:t,toolContext:o}){this.log("\u{1F527} TOOL STARTING"),this.log("   Tool Name: ".concat(e.name)),this.log("   Agent: ".concat(o.agentName)),this.log("   Function Call ID: ".concat(o.functionCallId)),this.log("   Arguments: ".concat(this.formatArgs(t)))}async afterToolCallback({tool:e,toolContext:t,result:o}){this.log("\u{1F527} TOOL COMPLETED"),this.log("   Tool Name: ".concat(e.name)),this.log("   Agent: ".concat(t.agentName)),this.log("   Function Call ID: ".concat(t.functionCallId)),this.log("   Result: ".concat(this.formatArgs(o)))}async onModelErrorCallback({callbackContext:e,error:t}){this.log("\u{1F9E0} LLM ERROR"),this.log("   Agent: ".concat(e.agentName)),this.log("   Error: ".concat(t))}async onToolErrorCallback({tool:e,toolArgs:t,toolContext:o,error:r}){this.log("\u{1F527} TOOL ERROR"),this.log("   Tool Name: ".concat(e.name)),this.log("   Agent: ".concat(o.agentName)),this.log("   Function Call ID: ".concat(o.functionCallId)),this.log("   Arguments: ".concat(this.formatArgs(t))),this.log("   Error: ".concat(r))}log(e){let t="\x1B[90m[".concat(this.name,"] ").concat(e,"\x1B[0m");h.info(t)}formatContent(e,t=200){if(!e||!e.parts)return"None";let o=[];for(let r of e.parts)if(r.text){let i=r.text.trim();i.length>t&&(i=i.substring(0,t)+"..."),o.push("text: '".concat(i,"'"))}else r.functionCall?o.push("function_call: ".concat(r.functionCall.name)):r.functionResponse?o.push("function_response: ".concat(r.functionResponse.name)):r.codeExecutionResult?o.push("code_execution_result"):o.push("other_part");return o.join(" | ")}formatArgs(e,t=300){if(!e)return"{}";let o=JSON.stringify(e);return o.length>t&&(o=o.substring(0,t)+"...}"),o}};var Ee=class{constructor(e){this.plugins=new Set;if(e)for(let t of e)this.registerPlugin(t)}registerPlugin(e){if(this.plugins.has(e))throw new Error("Plugin '".concat(e.name,"' already registered."));if(Array.from(this.plugins).some(t=>t.name===e.name))throw new Error("Plugin with name '".concat(e.name,"' already registered."));this.plugins.add(e),h.info("Plugin '".concat(e.name,"' registered."))}getPlugin(e){return Array.from(this.plugins).find(t=>t.name===e)}async runCallbacks(e,t,o){for(let r of e)try{let i=await t(r);if(i!==void 0)return h.debug("Plugin '".concat(r.name,"' returned a value for callback '").concat(o,"', exiting early.")),i}catch(i){let s="Error in plugin '".concat(r.name,"' during '").concat(o,"' callback: ").concat(i);throw h.error(s),new Error(s)}}async runOnUserMessageCallback({userMessage:e,invocationContext:t}){return await this.runCallbacks(this.plugins,o=>o.onUserMessageCallback({userMessage:e,invocationContext:t}),"onUserMessageCallback")}async runBeforeRunCallback({invocationContext:e}){return await this.runCallbacks(this.plugins,t=>t.beforeRunCallback({invocationContext:e}),"beforeRunCallback")}async runAfterRunCallback({invocationContext:e}){await this.runCallbacks(this.plugins,t=>t.afterRunCallback({invocationContext:e}),"afterRunCallback")}async runOnEventCallback({invocationContext:e,event:t}){return await this.runCallbacks(this.plugins,o=>o.onEventCallback({invocationContext:e,event:t}),"onEventCallback")}async runBeforeAgentCallback({agent:e,callbackContext:t}){return await this.runCallbacks(this.plugins,o=>o.beforeAgentCallback({agent:e,callbackContext:t}),"beforeAgentCallback")}async runAfterAgentCallback({agent:e,callbackContext:t}){return await this.runCallbacks(this.plugins,o=>o.afterAgentCallback({agent:e,callbackContext:t}),"afterAgentCallback")}async runBeforeToolCallback({tool:e,toolArgs:t,toolContext:o}){return await this.runCallbacks(this.plugins,r=>r.beforeToolCallback({tool:e,toolArgs:t,toolContext:o}),"beforeToolCallback")}async runAfterToolCallback({tool:e,toolArgs:t,toolContext:o,result:r}){return await this.runCallbacks(this.plugins,i=>i.afterToolCallback({tool:e,toolArgs:t,toolContext:o,result:r}),"afterToolCallback")}async runOnModelErrorCallback({callbackContext:e,llmRequest:t,error:o}){return await this.runCallbacks(this.plugins,r=>r.onModelErrorCallback({callbackContext:e,llmRequest:t,error:o}),"onModelErrorCallback")}async runBeforeModelCallback({callbackContext:e,llmRequest:t}){return await this.runCallbacks(this.plugins,o=>o.beforeModelCallback({callbackContext:e,llmRequest:t}),"beforeModelCallback")}async runAfterModelCallback({callbackContext:e,llmResponse:t}){return await this.runCallbacks(this.plugins,o=>o.afterModelCallback({callbackContext:e,llmResponse:t}),"afterModelCallback")}async runOnToolErrorCallback({tool:e,toolArgs:t,toolContext:o,error:r}){return await this.runCallbacks(this.plugins,i=>i.onToolErrorCallback({tool:e,toolArgs:t,toolContext:o,error:r}),"onToolErrorCallback")}};var uo="adk_request_confirmation",$t="orcas_tool_call_security_check_states",lo="This tool call needs external confirmation before completion.",fo=(o=>(o.DENY="DENY",o.CONFIRM="CONFIRM",o.ALLOW="ALLOW",o))(fo||{}),Oe=class{async evaluate(){return Promise.resolve({outcome:"ALLOW",reason:"For prototyping purpose, all tool calls are allowed."})}},Ut=class extends X{constructor(e){var t;super("security_plugin"),this.policyEngine=(t=e==null?void 0:e.policyEngine)!=null?t:new Oe}async beforeToolCallback({tool:e,toolArgs:t,toolContext:o}){let r=this.getToolCallCheckState(o);if(!r)return this.checkToolCallPolicy({tool:e,toolArgs:t,toolContext:o});if(r==="CONFIRM"){if(!o.toolConfirmation)return{partial:lo};if(this.setToolCallCheckState(o,o.toolConfirmation),!o.toolConfirmation.confirmed)return{error:"Tool call rejected from confirmation flow."};o.toolConfirmation=void 0}}getToolCallCheckState(e){var r;let{functionCallId:t}=e;return t?((r=e.state.get($t))!=null?r:{})[t]:void 0}setToolCallCheckState(e,t){var i;let{functionCallId:o}=e;if(!o)return;let r=(i=e.state.get($t))!=null?i:{};r[o]=t,e.state.set($t,r)}async checkToolCallPolicy({tool:e,toolArgs:t,toolContext:o}){let r=await this.policyEngine.evaluate({tool:e,toolArgs:t});switch(this.setToolCallCheckState(o,r.outcome),r.outcome){case"DENY":return{error:"This tool call is rejected by policy engine. Reason: ".concat(r.reason)};case"CONFIRM":return o.requestConfirmation({hint:"Policy engine requires confirmation calling tool: ".concat(e.name,". Reason: ").concat(r.reason)}),{partial:lo};case"ALLOW":return;default:return}}};function jr(n){if(!n.content||!n.content.parts)return[];let e=[];for(let t of n.content.parts)t&&t.functionCall&&t.functionCall.name===uo&&e.push(t.functionCall);return e}import{cloneDeep as po}from"lodash-es";var Ne=class{async appendEvent({session:e,event:t}){return t.partial||(this.updateSessionState({session:e,event:t}),e.events.push(t)),t}updateSessionState({session:e,event:t}){if(!(!t.actions||!t.actions.stateDelta))for(let[o,r]of Object.entries(t.actions.stateDelta))o.startsWith(b.TEMP_PREFIX)||(e.state[o]=r)}};function Fe(n){return{id:n.id,appName:n.appName,userId:n.userId||"",state:n.state||{},events:n.events||[],lastUpdateTime:n.lastUpdateTime||0}}var H=class extends Ne{constructor(){super(...arguments);this.sessions={};this.userState={};this.appState={}}createSession({appName:t,userId:o,state:r,sessionId:i}){let s=Fe({id:i||re(),appName:t,userId:o,state:r,events:[],lastUpdateTime:Date.now()});return this.sessions[t]||(this.sessions[t]={}),this.sessions[t][o]||(this.sessions[t][o]={}),this.sessions[t][o][s.id]=s,Promise.resolve(this.mergeState(t,o,po(s)))}getSession({appName:t,userId:o,sessionId:r,config:i}){if(!this.sessions[t]||!this.sessions[t][o]||!this.sessions[t][o][r])return Promise.resolve(void 0);let s=this.sessions[t][o][r],a=po(s);if(i&&(i.numRecentEvents&&(a.events=a.events.slice(-i.numRecentEvents)),i.afterTimestamp)){let c=a.events.length-1;for(;c>=0&&!(a.events[c].timestamp<i.afterTimestamp);)c--;c>=0&&(a.events=a.events.slice(c+1))}return Promise.resolve(this.mergeState(t,o,a))}listSessions({appName:t,userId:o}){if(!this.sessions[t]||!this.sessions[t][o])return Promise.resolve({sessions:[]});let r=[];for(let i of Object.values(this.sessions[t][o]))r.push(Fe({id:i.id,appName:i.appName,userId:i.userId,state:{},events:[],lastUpdateTime:i.lastUpdateTime}));return Promise.resolve({sessions:r})}async deleteSession({appName:t,userId:o,sessionId:r}){await this.getSession({appName:t,userId:o,sessionId:r})&&delete this.sessions[t][o][r]}async appendEvent({session:t,event:o}){await super.appendEvent({session:t,event:o}),t.lastUpdateTime=o.timestamp;let r=t.appName,i=t.userId,s=t.id,a=l=>{h.warn("Failed to append event to session ".concat(s,": ").concat(l))};if(!this.sessions[r])return a("appName ".concat(r," not in sessions")),o;if(!this.sessions[r][i])return a("userId ".concat(i," not in sessions[appName]")),o;if(!this.sessions[r][i][s])return a("sessionId ".concat(s," not in sessions[appName][userId]")),o;if(o.actions&&o.actions.stateDelta)for(let l of Object.keys(o.actions.stateDelta))l.startsWith(b.APP_PREFIX)&&(this.appState[r]=this.appState[r]||{},this.appState[r][l.replace(b.APP_PREFIX,"")]=o.actions.stateDelta[l]),l.startsWith(b.USER_PREFIX)&&(this.userState[r]=this.userState[r]||{},this.userState[r][i]=this.userState[r][i]||{},this.userState[r][i][l.replace(b.USER_PREFIX,"")]=o.actions.stateDelta[l]);let c=this.sessions[r][i][s];return await super.appendEvent({session:c,event:o}),c.lastUpdateTime=o.timestamp,o}mergeState(t,o,r){if(this.appState[t])for(let i of Object.keys(this.appState[t]))r.state[b.APP_PREFIX+i]=this.appState[t][i];if(!this.userState[t]||!this.userState[t][o])return r;for(let i of Object.keys(this.userState[t][o]))r.state[b.USER_PREFIX+i]=this.userState[t][o][i];return r}};import{createPartFromText as Vr}from"@google/genai";import{context as Kr,trace as Zr}from"@opentelemetry/api";var ee=class{constructor(e){var t;this.appName=e.appName,this.agent=e.agent,this.pluginManager=new Ee((t=e.plugins)!=null?t:[]),this.artifactService=e.artifactService,this.sessionService=e.sessionService,this.memoryService=e.memoryService,this.credentialService=e.credentialService}runAsync(e){return m(this,null,function*(){let{userId:t,sessionId:o,stateDelta:r}=e,i=Vn(e.runConfig),s=e.newMessage,a=D.startSpan("invocation"),c=Zr.setSpan(Kr.active(),a);try{yield*z(j(c,this,function(){return m(this,null,function*(){var p;let l=yield new f(this.sessionService.getSession({appName:this.appName,userId:t,sessionId:o}));if(!l)throw this.appName?new Error("Session not found: ".concat(o)):new Error("Session lookup failed: appName must be provided in runner constructor");if(i.supportCfc&&R(this.agent)){let A=this.agent.canonicalModel.model;if(!he(A))throw new Error("CFC is not supported for model: ".concat(A," in agent: ").concat(this.agent.name));ve(this.agent.codeExecutor)||(this.agent.codeExecutor=new Ce)}let u=new $({artifactService:this.artifactService,sessionService:this.sessionService,memoryService:this.memoryService,credentialService:this.credentialService,invocationId:un(),agent:this.agent,session:l,userContent:s,runConfig:i,pluginManager:this.pluginManager}),d=yield new f(this.pluginManager.runOnUserMessageCallback({userMessage:s,invocationContext:u}));if(d&&(s=d),s){if(!((p=s.parts)!=null&&p.length))throw new Error("No parts in the newMessage.");i.saveInputBlobsAsArtifacts&&(yield new f(this.saveArtifacts(u.invocationId,l.userId,l.id,s))),yield new f(this.sessionService.appendEvent({session:l,event:S({invocationId:u.invocationId,author:"user",actions:r?F({stateDelta:r}):void 0,content:s})}))}if(u.agent=this.determineAgentForResumption(l,this.agent),s){let A=yield new f(this.pluginManager.runBeforeRunCallback({invocationContext:u}));if(A){let I=S({invocationId:u.invocationId,author:"model",content:A});yield new f(this.sessionService.appendEvent({session:l,event:I})),yield I}else{try{for(var C=y(u.agent.runAsync(u)),v,x,g;v=!(x=yield new f(C.next())).done;v=!1){let I=x.value;I.partial||(yield new f(this.sessionService.appendEvent({session:l,event:I})));let L=yield new f(this.pluginManager.runOnEventCallback({invocationContext:u,event:I}));L?yield L:yield I}}catch(x){g=[x]}finally{try{v&&(x=C.return)&&(yield new f(x.call(C)))}finally{if(g)throw g[0]}}yield new f(this.pluginManager.runAfterRunCallback({invocationContext:u}))}}})}))}finally{a.end()}})}async saveArtifacts(e,t,o,r){var i;if(!(!this.artifactService||!((i=r.parts)!=null&&i.length)))for(let s=0;s<r.parts.length;s++){let a=r.parts[s];if(!a.inlineData)continue;let c="artifact_".concat(e,"_").concat(s);await this.artifactService.saveArtifact({appName:this.appName,userId:t,sessionId:o,filename:c,artifact:a}),r.parts[s]=Vr("Uploaded file: ".concat(c,". It is saved into artifacts"))}}determineAgentForResumption(e,t){let o=Jr(e.events);if(o&&o.author)return t.findAgent(o.author)||t;for(let r=e.events.length-1;r>=0;r--){h.info("event: ",JSON.stringify(e.events[r]));let i=e.events[r];if(i.author==="user"||!i.author)continue;if(i.author===t.name)return t;let s=t.findSubAgent(i.author);if(!s){h.warn("Event from an unknown agent: ".concat(i.author,", event id: ").concat(i.id));continue}if(this.isRoutableLlmAgent(s))return s}return t}isRoutableLlmAgent(e){let t=e;for(;t;){if(!R(t)||t.disallowTransferToParent)return!1;t=t.parentAgent}return!0}};function Jr(n){var o,r,i,s;if(!n.length)return null;let t=(s=(i=(r=(o=n[n.length-1].content)==null?void 0:o.parts)==null?void 0:r.find(a=>a.functionResponse))==null?void 0:i.functionResponse)==null?void 0:s.id;if(!t)return null;for(let a=n.length-2;a>=0;a--){let c=n[a],l=w(c);if(l){for(let u of l)if(u.id===t)return c}}return null}var qt=class extends ee{constructor({agent:e,appName:t="InMemoryRunner",plugins:o=[]}){super({appName:t,agent:e,plugins:o,artifactService:new ye,sessionService:new H,memoryService:new Q})}};import{Type as Ge}from"@google/genai";var De=class{constructor(e){this.toolContext=e;this.invocationContext=e.invocationContext}async saveArtifact(e){return this.toolContext.saveArtifact(e.filename,e.artifact)}async loadArtifact(e){return this.toolContext.loadArtifact(e.filename,e.version)}async listArtifactKeys(){return this.toolContext.listArtifacts()}async deleteArtifact(e){if(!this.toolContext.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.toolContext.invocationContext.artifactService.deleteArtifact(e)}async listVersions(e){if(!this.toolContext.invocationContext.artifactService)throw new Error("Artifact service is not initialized.");return this.toolContext.invocationContext.artifactService.listVersions(e)}};var zt=Symbol.for("google.adk.agentTool");function Wr(n){return typeof n=="object"&&n!==null&&zt in n&&n[zt]===!0}var mo,go,jt=class extends(go=N,mo=zt,go){constructor(t){super({name:t.agent.name,description:t.agent.description||""});this[mo]=!0;this.agent=t.agent,this.skipSummarization=t.skipSummarization||!1}_getDeclaration(){let t;if(R(this.agent)&&this.agent.inputSchema?t={name:this.name,description:this.description,parameters:this.agent.inputSchema}:t={name:this.name,description:this.description,parameters:{type:Ge.OBJECT,properties:{request:{type:Ge.STRING}},required:["request"]}},this.apiVariant!=="GEMINI_API"){let o=R(this.agent)&&this.agent.outputSchema;t.response=o?{type:Ge.OBJECT}:{type:Ge.STRING}}return t}async runAsync({args:t,toolContext:o}){var x,g;this.skipSummarization&&(o.actions.skipSummarization=!0);let i={role:"user",parts:[{text:R(this.agent)&&this.agent.inputSchema?JSON.stringify(t):t.request}]},s=new ee({appName:this.agent.name,agent:this.agent,artifactService:new De(o),sessionService:new H,memoryService:new Q,credentialService:o.invocationContext.credentialService}),a=await s.sessionService.createSession({appName:this.agent.name,userId:"tmp_user",state:o.state.toRecord()}),c;try{for(var d=y(s.runAsync({userId:a.userId,sessionId:a.id,newMessage:i})),p,C,v;p=!(C=await d.next()).done;p=!1){let A=C.value;A.actions.stateDelta&&o.state.update(A.actions.stateDelta),c=A}}catch(C){v=[C]}finally{try{p&&(C=d.return)&&await C.call(d)}finally{if(v)throw v[0]}}if(!((g=(x=c==null?void 0:c.content)==null?void 0:x.parts)!=null&&g.length))return"";let l=R(this.agent)&&this.agent.outputSchema,u=c.content.parts.map(A=>A.text).filter(A=>A).join("\n");return l?JSON.parse(u):u}};var Vt=class{constructor(e){this.toolFilter=e}isToolSelected(e,t){return this.toolFilter?typeof this.toolFilter=="function"?this.toolFilter(e,t):Array.isArray(this.toolFilter)?this.toolFilter.includes(e.name):!1:!0}async processLlmRequest(e,t){}};var $e=class extends N{constructor(){super({name:"google_search",description:"Google Search Tool"})}runAsync(){return Promise.resolve()}async processLlmRequest({llmRequest:e}){if(e.model){if(e.config=e.config||{},e.config.tools=e.config.tools||[],bn(e.model)){if(e.config.tools.length>0)throw new Error("Google search tool can not be used with other tools in Gemini 1.x.");e.config.tools.push({googleSearchRetrieval:{}});return}if(En(e.model)){e.config.tools.push({googleSearch:{}});return}throw new Error("Google search tool is not supported for model ".concat(e.model))}}},Yr=new $e;var ho="\n\nNOTE: This is a long-running operation. Do not call this tool again if it has already returned some intermediate or pending status.",Kt=class extends U{constructor(e){super(ne(E({},e),{isLongRunning:!0}))}_getDeclaration(){let e=super._getDeclaration();return e.description?e.description+=ho:e.description=ho.trimStart(),e}};export{qe as ActiveStreamingTool,jt as AgentTool,so as AuthCredentialTypes,O as BaseAgent,ge as BaseCodeExecutor,Dt as BaseExampleProvider,ae as BaseLlm,G as BaseLlmRequestProcessor,Je as BaseLlmResponseProcessor,X as BasePlugin,Ne as BaseSessionService,N as BaseTool,Vt as BaseToolset,Ce as BuiltInCodeExecutor,B as CallbackContext,U as FunctionTool,Yr as GOOGLE_SEARCH,ce as Gemini,Le as GoogleLLMVariant,$e as GoogleSearchTool,ye as InMemoryArtifactService,Q as InMemoryMemoryService,Oe as InMemoryPolicyEngine,qt as InMemoryRunner,H as InMemorySessionService,$ as InvocationContext,le as LLMRegistry,tt as LiveRequestQueue,Y as LlmAgent,gn as LogLevel,Gt as LoggingPlugin,Kt as LongRunningFunctionTool,Pt as LoopAgent,Bt as ParallelAgent,Ee as PluginManager,fo as PolicyOutcome,uo as REQUEST_CONFIRMATION_FUNCTION_CALL_NAME,P as ReadonlyContext,ee as Runner,Ut as SecurityPlugin,Nt as SequentialAgent,b as State,xt as StreamingMode,V as ToolConfirmation,q as ToolContext,S as createEvent,F as createEventActions,Fe as createSession,Do as functionsExportedForTestingOnly,jr as getAskUserConfirmationFunctionCalls,w as getFunctionCalls,_ as getFunctionResponses,No as getLogger,Ht as hasTrailingCodeExecutionResult,Wr as isAgentTool,Ro as isBaseAgent,Ur as isBaseExampleProvider,ut as isBaseLlm,tr as isBaseTool,oe as isFinalResponse,ur as isFunctionTool,he as isGemini2OrAbove,R as isLlmAgent,Or as isLoopAgent,Nr as isParallelAgent,Gr as isSequentialAgent,Po as setLogLevel,Oo as setLogger,yo as stringifyContent,ue as version,ht as zodObjectToSchema};
/**
 * @license
 * Copyright 2025 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */
//# sourceMappingURL=index.js.map
